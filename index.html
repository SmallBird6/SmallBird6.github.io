<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 4.0.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/xiaoniao.jpg">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/xiaoniao.jpg">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css">


<script id="hexo-configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Gemini',
    version: '7.5.0',
    exturl: false,
    sidebar: {"position":"left","display":"post","offset":12,"onmobile":false},
    copycode: {"enable":true,"show_result":true,"style":"default"},
    back2top: {"enable":true,"sidebar":true,"scrollpercent":true},
    bookmark: {"enable":true,"color":"#222","save":"manual"},
    fancybox: false,
    mediumzoom: false,
    lazyload: false,
    pangu: false,
    algolia: {
      appID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    },
    localsearch: {"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},
    path: '',
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    translation: {
      copy_button: '复制',
      copy_success: '复制成功',
      copy_failure: '复制失败'
    },
    sidebarPadding: 40
  };
</script>

  <meta property="og:type" content="website">
<meta property="og:title" content="SmallBird&#96;s Blog">
<meta property="og:url" content="http:&#x2F;&#x2F;yoursite.com&#x2F;index.html">
<meta property="og:site_name" content="SmallBird&#96;s Blog">
<meta property="og:locale" content="zh-CN">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://yoursite.com/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome: true,
    isPost: false,
    isPage: false,
    isArchive: false
  };
</script>

  <title>SmallBird`s Blog</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-meta">

    <div>
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">SmallBird`s Blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
        <p class="site-subtitle">今春看又过，何日是归年?</p>
  </div>

  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>
</div>


<nav class="site-nav">
  
  <ul id="menu" class="menu">
        <li class="menu-item menu-item-首页">

    <a href="/" rel="section"><i class="fa fa-fw fa-home"></i>首页</a>

  </li>
        <li class="menu-item menu-item-分类">

    <a href="/categories/" rel="section"><i class="fa fa-fw fa-th"></i>分类</a>

  </li>
        <li class="menu-item menu-item-标签">

    <a href="/tags/" rel="section"><i class="fa fa-fw fa-tags"></i>标签</a>

  </li>
        <li class="menu-item menu-item-归档">

    <a href="/archives/" rel="section"><i class="fa fa-fw fa-archive"></i>归档</a>

  </li>
        <li class="menu-item menu-item-关于">

    <a href="/about/" rel="section"><i class="fa fa-fw fa-user"></i>关于</a>

  </li>
  </ul>

</nav>
</div>
    </header>

    
  <a role="button" class="book-mark-link book-mark-link-fixed"></a>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content">
            

  <div class="posts-expand">
        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/05/05/Hadoop3-1-3-%E6%BA%90%E7%A0%81%E7%BC%96%E8%AF%91/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/xiaoniao.jpg">
      <meta itemprop="name" content="SmallBird">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="SmallBird`s Blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2020/05/05/Hadoop3-1-3-%E6%BA%90%E7%A0%81%E7%BC%96%E8%AF%91/" class="post-title-link" itemprop="url">Hadoop3.1.3 源码编译</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2020-05-05 20:07:53 / 修改时间：20:29:27" itemprop="dateCreated datePublished" datetime="2020-05-05T20:07:53+08:00">2020-05-05</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Hadoop/" itemprop="url" rel="index">
                    <span itemprop="name">Hadoop</span>
                  </a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="Hadoop-3-1-3-源码编译"><a href="#Hadoop-3-1-3-源码编译" class="headerlink" title="Hadoop 3.1.3 源码编译"></a>Hadoop 3.1.3 源码编译</h1><h2 id="准备工作-下载软件安装包"><a href="#准备工作-下载软件安装包" class="headerlink" title="准备工作(下载软件安装包)"></a>准备工作(下载软件安装包)</h2><ol>
<li><p>JDK(HADOOP3需要的java版本为1.8)</p>
</li>
<li><p>Maven(3.5版本以上即可)</p>
</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">//阿里云镜像配置</span><br><span class="line">&lt;mirror&gt;</span><br><span class="line">  &lt;id&gt;alimaven&lt;/id&gt;</span><br><span class="line">  &lt;name&gt;aliyun maven&lt;/name&gt;</span><br><span class="line">  &lt;url&gt;http://maven.aliyun.com/nexus/content/groups/public/&lt;/url&gt;</span><br><span class="line">  &lt;mirrorOf&gt;central&lt;/mirrorOf&gt;       </span><br><span class="line">&lt;/mirror&gt;</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>protobuf-2.5.0.tar.gz</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Download : https://github.com/protocolbuffers/protobuf/releases/tag/v2.5.0</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>cmake-3.8.2.tar.gz (yum安装可能无法安装高版本，编译hadoop3.1.3至少需要cmake3.7以上)</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Download : https://cmake.org/files/v3.13/</span><br></pre></td></tr></table></figure>

<ol start="5">
<li>hadoop-3.1.3-src.tar.gz (Hadoop源码)</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget https://mirror.bit.edu.cn/apache/hadoop/common/hadoop-3.1.3/hadoop-3.1.3-src.tar.gz</span><br></pre></td></tr></table></figure>

<ol start="6">
<li><code>yum install -y gcc-c++ glibc-header openssl-devel zlib-devel</code></li>
</ol>
<h2 id="安装cmake"><a href="#安装cmake" class="headerlink" title="安装cmake"></a>安装cmake</h2><ol>
<li><p>删除yum安装的低版本的cmake : <code>yum erase cmake</code></p>
</li>
<li><p>解压安装包</p>
</li>
<li><p>进入目录进行编译 : <code>./configure</code></p>
</li>
<li><p>安装 : <code>make &amp;&amp; make install</code></p>
</li>
<li><p>验证 : <code>cmake -version</code></p>
</li>
</ol>
<h2 id="安装ProtocolBuffer"><a href="#安装ProtocolBuffer" class="headerlink" title="安装ProtocolBuffer"></a>安装ProtocolBuffer</h2><ol>
<li><p>解压安装包</p>
</li>
<li><p>创建编译之后软件的路径 : <code>mkdir /opt/protobuf</code></p>
</li>
<li><p>进入解压后文件目录,编译到软件路径 : <code>./configure --prefix=/opt/protobuf</code></p>
</li>
<li><p>安装 : <code>make &amp;&amp; make install</code></p>
</li>
<li><p>配置环境变量</p>
</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">export PROTOC_HOME=/apps/protobuf</span><br><span class="line">export PATH=$PROTOC_HOME/bin:$PATH</span><br></pre></td></tr></table></figure>

<ol start="6">
<li>验证 : <code>protoc --version</code></li>
</ol>
<h2 id="Hadoop3-1-3-编译"><a href="#Hadoop3-1-3-编译" class="headerlink" title="Hadoop3.1.3 编译"></a>Hadoop3.1.3 编译</h2><ol>
<li><p>解压源码包，进入目录</p>
</li>
<li><p>执行编译命令</p>
</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">// 正常编译</span><br><span class="line">mvn clean package -DskipTests -Pdist,native -Dtar</span><br><span class="line"></span><br><span class="line">// Yarn开启Kerberos 重新编译contaniner脚本</span><br><span class="line">mvn package -Pdist,native -DskipTests -Dtar -Dcontainer-executor.conf.dir=/etc</span><br><span class="line">/* </span><br><span class="line">1. container-executor默认是DefaultContainerExecutor，是以起Nodemanager的用户身份启动container的，切换为LinuxContainerExecutor会以提交application的用户身份来启动，它使用一个setuid可执行文件来启动和销毁container</span><br><span class="line">2. container-executor.conf.dir必须显示注明，它表示setuid可执行文件依赖的配置文件路径，默认会在$HADOOP_HOME/etc/hadoop下，不过由于该文件需要父目录和以上的目录的owner都为root，要不然会有以下报错，所以为了方便我们设置为/etc</span><br><span class="line">Caused by: org.apache.hadoop.util.Shell$ExitCodeException: File /usr/local/hadoop/hadoop-2.1.0-beta/etc/hadoop must be owned by root, but is owned by 500</span><br><span class="line">*/</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/03/18/Kerberos%E8%AE%A4%E8%AF%81/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/xiaoniao.jpg">
      <meta itemprop="name" content="SmallBird">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="SmallBird`s Blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2020/03/18/Kerberos%E8%AE%A4%E8%AF%81/" class="post-title-link" itemprop="url">Kerberos认证</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-03-18 10:54:13" itemprop="dateCreated datePublished" datetime="2020-03-18T10:54:13+08:00">2020-03-18</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2020-06-22 16:05:44" itemprop="dateModified" datetime="2020-06-22T16:05:44+08:00">2020-06-22</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Kerberos/" itemprop="url" rel="index">
                    <span itemprop="name">Kerberos</span>
                  </a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="Kerberos概述"><a href="#Kerberos概述" class="headerlink" title="Kerberos概述"></a>Kerberos概述</h1><h2 id="Kerberos技术概况"><a href="#Kerberos技术概况" class="headerlink" title="Kerberos技术概况"></a>Kerberos技术概况</h2><p>Kerberos技术是一种计算机网络授权协议，用于在非安全的网络环境下对个人通信进行加密认证。Kerberos协议认证过程的实现不依赖于主机操作系统的认证，无需基于主机地址的信任，不要求网络上所有主机的物理安全，并且是以假定网络上传送的数据包可以被任意的读取，修改和插入数据为前提设计的</p>
<p><strong>Kerberos设计的目标如下：</strong></p>
<ul>
<li>用户的密码不能在网络上传输</li>
<li>用户的密码绝不能以任何形式存储在客户机上，使用后必须立刻销毁</li>
<li>用户的密码不应该以未加密的形式被存储</li>
<li>用户在一次工作会话期间只会被要求输入一次密码，因此用户能够在这次会话期间透明的访问所有服务而无需重新输入密码</li>
<li>认证信息的管理集中在认证服务器上，应用服务器上不能保留用户的身份验证信息，以此来实现以下的功能<ul>
<li>管理员可以通过修改认证服务器的设置来对指定用户的账户进行修改，而不用修改应用服务器</li>
<li>当用户修改密码时，将在所有服务器上生效</li>
<li>没有需要保护的冗余信息</li>
<li>不仅用户需要向应用服务器证明他们的身份，应用服务器在返回时也需要向客户端证明他们的真实性，实现双向验证</li>
<li>在完成身份的验证后，客户端和服务器必须能够建立一个加密的连接，因此Kerberos需要为生成和交换加密密钥提供支持</li>
</ul>
</li>
</ul>
<p>Kerberos通过定义用户和服务端所使用的认证身份(Principal)来进行访问控制，用户通过Kerberos客户端使用自己的Principal向认证服务器进行身份的认证，认证成功后服务器会将表示用户身份的票据(Ticket<br>)返回用户，在之后的通信过程中Kerberos客户端使用已认证的票据进行安全的通信</p>
<h2 id="Kerberos架构"><a href="#Kerberos架构" class="headerlink" title="Kerberos架构"></a>Kerberos架构</h2><p>Kerberos的总体架构，由Kerberos服务器KDC、客户端(Client)和应用服务器{Server}组成，其中KDC包含了Authentication Service和Ticket Granting Service两种服务</p>
<ol>
<li>KDC ：Key Distribution Center，即密钥分发中心。就是通常所说的认证服务器，它是参与用户和服务认证的基本对象。由于他有密钥分配的功能并且可以作为服务接入，因此被称为密钥分发中心，简称KDC。KDC通常是一台单独的物理服务器，他可以从逻辑上分为3个部分：数据库(Database)、认证服务(Authentication Service)和票据授权服务(Ticket Granting Service)</li>
<li>Database ：数据库，用于存放用户和服务的记录，Kerberos的数据库中使用Principal来命名和引用一条记录。Kerberos数据库中的记录包含以下内容 ：<ul>
<li>记录所关联的Principal</li>
<li>加密密钥和相关的KVNO</li>
<li>与Principal关联的票据的最长有效期</li>
<li>与Principal关联的票据的最长更新周期</li>
<li>描述票据的参数或标志</li>
<li>密码过期时间</li>
<li>Principal的过期时间</li>
</ul>
</li>
<li>Application Server ：应用服务器，例如指所有提供Hadoop以及相关服务的主机，应用服务器上需要安装Kerberos客户端，在相关服务中开启对Kerberos协议的支持，并且对服务所使用的Principl进行配置</li>
<li>Client ：客户机，用户使用客户机来获得应用服务器提供的各项服务，客户机上需要安装Kerberos客户端。在使用时，用户需要先向KDC进行身份的认证，才能从应用服务器获得相应的服务</li>
<li>AS ：Authentication Service，认证服务。认证服务是KDC中用于回复客户端最初的认证请求的部分，如果用户没有认证过，必须输入密码。在回应认证请求时，AS会授予一个特殊的被称为票据授权的票据(Ticket Granting Ticket)，简称TGT。如果用户确实是他们所声称的身份，他们就可以使用TGT在无须再次输入密码的情况下获得其他服务的票据</li>
<li>TGS ：Ticket Granting Service，票据授权服务。票据授权服务是KDC中负责根据用户提交的有效TGT分配服务票据(Service Ticket)的组件，同时TGS保证向应用服务器请求资源的身份的真实性。TGS可以被视为一个应用服务器，提供服务票据的功能</li>
<li>ST ：Service Ticket，服务票据，由KDC的TGS发放，任何一个应用(Application)都需要一张有效的服务票据才能访问。如果能正确接受ST，说明Client和Server之间的信任关系已经被建立。ST通常为一张数字加密的证书</li>
<li>TGT ：Ticket Granting Ticket，票据授权票据，由KDC的AS发放。获得这样一张票据后，在申请其他应用的服务票据时，就不需要向KDC提交身份认证信息。TGT具有一定的有效期，到期后需要更新来续约</li>
<li>Ticket ：票据。票据是客户端提交给应用服务器用于证明其身份真实性的。票据由认证服务器颁发，并使用所需要的服务端密钥加密。由于服务端密钥只存在于认证服务器与应用服务器之间，获取到该票据的客户端也无法知道服务端密钥，因为也无法对票据进行修改。一张票据中包含了以下信息 ： <ul>
<li>请求用户的Principal(一般来说是用户名)</li>
<li>用户所请求的服务Principal</li>
<li>可以使用该票据的客户端IP地址(可选)</li>
<li>票据的生效日期与时间(使用时间戳格式)</li>
<li>票据的有效时间</li>
<li>会话密钥(Session Key)<br>每张票据都会有过期时间(通常为10小时)，这是必要的。虽然认证服务器的管理员可以控制不再发布新的票据，但无法阻止用户使用已经发布的票据。因为认证服务器无法对已经发布的票据进行控制，所以过期时间的设置可以防止票据被滥用</li>
</ul>
</li>
<li>KVNO ：Key Version Number，密钥版本号。当用户更改密码或管理员更新应用服务器的密钥时，这种修改将会使版本号增加</li>
</ol>
<h1 id="Kerberos使用"><a href="#Kerberos使用" class="headerlink" title="Kerberos使用"></a>Kerberos使用</h1><h2 id="名词解释"><a href="#名词解释" class="headerlink" title="名词解释"></a>名词解释</h2><ol>
<li>KDC ：Key Distribution Center，密钥分配中心。Kerberos认证服务的密钥分配中心，负责Kerberos密钥的分发和存储，KDC中自带一个数据库用于Realm和Principal等数据的存储</li>
<li>Principal ：Principal是Kerberos中参与认证的基本实体。通常来说Principal的含义有两种，一种用于表示Kerberos数据中的用户，一种用于表示一台特定的主机，可以认为Principal是代表了用户或主机的身份信息</li>
<li>Principal的命名格式 ：通常Principal的命名格式为Name/Instance@Realm。其中Name代表了用户名或主机名，Instance是对Name指代用户或主机的进一步描述，可以是用户所在的主机或类型等信息。Instance可以省略，在未省略的情况下需要与Name使用”/“隔开</li>
<li>Principal的认证 ：Kerberos中支持的用户认证方式有两种，一是由用户输入密码进行认证，二是将Principal导出至Keytab文件后使用Keytab文件面密码认证。对于一个Principal来说只能选择其中一种方式进行认证。由于Hadoop及其各组件中使用的机制原因，对于服务端的Kerberos认证只能使用Keytab文件进行认证</li>
<li>Realm ：作用域，指认证系统所管理的范围，用于指定认证服务所影响的用户、主机以及服务的边界。用户与服务并不一定要属于同一个Realm，如果双方所属不同的Realm，并且这两个Realm直接存在信赖关系，就能实现交叉认证。一般来说，当一个用户或服务属于一个Realm时，它与认证服务器直接存在一个共享的Realm密钥。Realm的名称也是KDC中存储Principal的域数据库名。Realm在使用时对字母的大小写敏感，因此一般使用大写字母来区分，同时建议使用网络环境的DNS作为Realm。在输入Principal时，Realm可以省略，省略后默认使用本地的Realm。在未省略时使用”@”号与Name或Instance分隔</li>
<li>Keytab ：保存了一个或多个Principal及其信息的密钥文件，由KDC管理员到处生成，用户可以直接进行免密码认证，因此需要注意密钥文件的文件权限<br>KDC与Keytab存在一种过期机制，当KDC导出一个Principal时，将会生成一个该Principal的KVNO，这个版本号会被保存在KDC以及导出的Keytab文件中，当用户使用Keytab认证时，如果Keytab中的KVNO标签与KDC中该Principal最后生成的KVNO不一致，将会认证失败。简单的说，如果使用KDC将一个Principal导出多次，那么最终只有最后导出的Keytab中的信息可以用于认证。因此，如果需要将某个Principal信息导出到多个不同的Keytab文件来使用，则需要使用ktutil工具将Keytab文件中的信息进行复制、合并</li>
</ol>
<h2 id="KDC常用操作"><a href="#KDC常用操作" class="headerlink" title="KDC常用操作"></a>KDC常用操作</h2><ol>
<li>kadmin.local ：打开KDC控制台，需要root权限</li>
<li>[addprinc <principal>] ：添加Principal，在KDC控制台使用，执行后需要两次输入该Principal的密码</li>
<li>[delprinc <principal>] ：删除Principal，在KDC控制台使用，执行后需要确认是否删除</li>
<li>[xst -k <keytab file path> <principal>] ：导出指定Principal到指定Keytab文件，在KDC控制台使用。如果指定的Keytab文件已存在，则会将指定Principal信息合并到Keytab文件中</li>
<li>[modprinc -<parameter> <parameter value> <principal>] ：针对指定的Principal进行某项参数的修改，在KDC控制台使用。需要注意的是，使用modprinc命令修改的参数，优先级会比kdc.conf中的高</li>
<li>[getprinc <principal>] ：查看指定Principal的信息，包括每种密钥的加密类型、KVNO标签等，在KDC控制台使用</li>
<li>[listprincs] ：列出所有Principal，在KDC控制台使用</li>
</ol>
<h2 id="Client常用操作"><a href="#Client常用操作" class="headerlink" title="Client常用操作"></a>Client常用操作</h2><ol>
<li>klist ：列出当前系统用户的Kerberos认证情况</li>
<li>klist -kt <keytab file path> ：列出指定Keytab文件中包含的Principal信息，需要该文件的读权限</li>
<li>kinit <principal> ：使用输入密码的方式认证指定的Principal</li>
<li>kinit -kt <keytab file path> <principal> ：使用指定Keytab中的指定Principal进行认证，需要该文件的读权限</li>
<li>kdestroy ：注销当前已经认证的Principal</li>
<li>ktutil ：进入Keytab工具控制台</li>
<li>[list][l] ：列出当前ktutil中的密钥表</li>
<li>[clear] [clear_list] ：清除当前密钥表</li>
<li>[rkt <keytab file path>] ：读取一个Keytab中的所用Principal信息到密钥表，需要有该文件的读权限，在ktutil中使用</li>
<li>[wkt <keytab file path>] ：将密钥表中的所有Principal信息写入指定文件中。如果文件已存在，则需要该文件的写权限，信息会附加至文件末，在ktutil中使用</li>
<li>[addent -password -p <principal> -k <KVNO> -e <enctype>] ：手动添加一条Principal信息到密钥表，执行后需要输入指定Principal的密码。由于手动添加的信息ktutil不会进行验证，因此不推荐使用</li>
<li>[delent <entity number>] ：从密钥表中删除指定行号的Principal信息，行号可使用list或者l命令查看，在ktutil中使用</li>
<li>[lr][list_request] ：列出所有ktutil中可用的命令，在ktutil中使用</li>
<li>[quit][q][exit] ：退出ktutil控制台</li>
</ol>
<h1 id="Kerberos部署安装"><a href="#Kerberos部署安装" class="headerlink" title="Kerberos部署安装"></a>Kerberos部署安装</h1><h2 id="Kerberos-HA-主备模式"><a href="#Kerberos-HA-主备模式" class="headerlink" title="Kerberos HA(主备模式)"></a>Kerberos HA(主备模式)</h2><p><strong>安装环境介绍</strong></p>
<ul>
<li>KerberosMaster : henghe-227</li>
<li>KerberosSlaves : henghe-228</li>
<li>KerberosClient : henghe-229</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">---关于AES-256加密---</span><br><span class="line"></span><br><span class="line">对于使用centos5. 6及以上的系统,默认使用 AES-256 来加密的.这就需要集群中的所有节点上安装 Java Cryptography Extension (JCE) Unlimited Strength Jurisdiction Policy File。</span><br><span class="line">下载的文件是一个 zip 包，解开后，将里面的两个文件放到下面的目录中 : $JAVA_HOME/jre/lib/security</span><br></pre></td></tr></table></figure>

<h3 id="RPM安装包准备和安装"><a href="#RPM安装包准备和安装" class="headerlink" title="RPM安装包准备和安装"></a>RPM安装包准备和安装</h3><p>下载地址 : <a href="https://centos.pkgs.org/" target="_blank" rel="noopener">https://centos.pkgs.org/</a></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">krb5-libs-1.15.1-46.el7.x86_64.rpm</span><br><span class="line">krb5-server-1.15.1-46.el7.x86_64.rpm</span><br><span class="line">krb5-workstation-1.15.1-46.el7.x86_64.rpm</span><br><span class="line">libevent-2.0.21-4.el7.x86_64.rpm</span><br><span class="line">libkadm5-1.15.1-46.el7.x86_64.rpm</span><br><span class="line">libverto-0.2.5-4.el7.x86_64.rpm</span><br><span class="line">libverto-libevent-0.2.5-4.el7.x86_64.rpm</span><br><span class="line">words-3.0-22.el7.noarch.rpm</span><br></pre></td></tr></table></figure>

<h3 id="服务端安装-Master和Slaves都一样安装"><a href="#服务端安装-Master和Slaves都一样安装" class="headerlink" title="服务端安装(Master和Slaves都一样安装)"></a>服务端安装(Master和Slaves都一样安装)</h3><blockquote>
<p><code>ibverto-0.2.5-4.el7.x86_64.rpm</code>,<code>libevent-2.0.21-4.el7.x86_64.rpm</code>是<code>libverto-libevent-0.2.5-4.el7.x86_64.rpm</code>的依赖包</p>
</blockquote>
<blockquote>
<p><code>words-3.0-22.el7.noarch.rpm</code>,<code>libkadm5-1.15.1-46.el7.x86_64.rpm</code>,<code>libverto-libevent-0.2.5-4.el7.x86_64.rpm</code>这三个安装包是<code>krb5-server-1.15.1-46.el7.x86_64.rpm</code>的依赖包</p>
</blockquote>
<p><strong>安装顺序</strong></p>
<ol>
<li>Centos7自带krb5-libs包，先卸载原有的包 : <code>rpm -e --nodeps krb5-lib***</code></li>
<li><code>rpm -ivh krb5-libs-1.15.1-46.el7.x86_64.rpm</code></li>
<li><code>rpm -ivh words-3.0-22.el7.noarch.rpm</code></li>
<li><code>rpm -ivh libkadm5-1.15.1-46.el7.x86_64.rpm</code></li>
<li><code>rpm -ivh libevent-2.0.21-4.el7.x86_64.rpm</code></li>
<li><code>rpm -ivh libverto-0.2.5-4.el7.x86_64.rpm</code></li>
<li><code>rpm -ivh libverto-libevent-0.2.5-4.el7.x86_64.rpm</code></li>
<li><code>rpm -ivh krb5-server-1.15.1-46.el7.x86_64.rpm</code></li>
<li><code>rpm -ivh krb5-workstation-1.15.1-46.el7.x86_64.rpm</code></li>
</ol>
<h3 id="Master和Slaves配置"><a href="#Master和Slaves配置" class="headerlink" title="Master和Slaves配置"></a>Master和Slaves配置</h3><h5 id="Master端"><a href="#Master端" class="headerlink" title="Master端"></a>Master端</h5><ol>
<li>编辑<code>/etc/krb5.conf</code>和<code>/var/kerberos/krb5kdc/kdc.conf</code>配置文件</li>
</ol>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">//</span> <span class="string">krb5.conf</span></span><br><span class="line"></span><br><span class="line"><span class="attr">includedir</span> <span class="string">/etc/krb5.conf.d/</span></span><br><span class="line"></span><br><span class="line"><span class="attr">[logging]</span></span><br><span class="line"> <span class="attr">default</span> = <span class="string">FILE:/var/log/krb5libs.log</span></span><br><span class="line"> <span class="attr">kdc</span> = <span class="string">FILE:/var/log/krb5kdc.log</span></span><br><span class="line"> <span class="attr">admin_server</span> = <span class="string">FILE:/var/log/kadmind.log</span></span><br><span class="line"></span><br><span class="line"><span class="attr">[libdefaults]</span></span><br><span class="line"> <span class="attr">dns_lookup_realm</span> = <span class="string">false</span></span><br><span class="line"> <span class="attr">ticket_lifetime</span> = <span class="string">24h</span></span><br><span class="line"> <span class="attr">renew_lifetime</span> = <span class="string">7d</span></span><br><span class="line"> <span class="attr">forwardable</span> = <span class="string">true</span></span><br><span class="line"> <span class="attr">rdns</span> = <span class="string">false</span></span><br><span class="line"> <span class="attr">pkinit_anchors</span> = <span class="string">/etc/pki/tls/certs/ca-bundle.crt</span></span><br><span class="line"> <span class="attr">default_realm</span> = <span class="string">HADOOP.COM</span></span><br><span class="line"><span class="comment"> #default_ccache_name = KEYRING:persistent:%&#123;uid&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">[realms]</span></span><br><span class="line"> <span class="meta">HADOOP.COM</span> = <span class="string">&#123;</span></span><br><span class="line">  <span class="attr">kdc</span> = <span class="string">henghe-227</span></span><br><span class="line">  <span class="attr">admin_server</span> = <span class="string">henghe-227</span></span><br><span class="line"> <span class="attr">&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">[domain_realm]</span></span><br><span class="line"> <span class="meta">.hadoop.com</span> = <span class="string">HADOOP.COM</span></span><br><span class="line"> <span class="meta">hadoop.com</span> = <span class="string">HADOOP.COM</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="attr">//kdc.conf</span></span><br><span class="line"></span><br><span class="line"><span class="attr">修改域名为HADOOP.COM</span></span><br></pre></td></tr></table></figure>

<ol start="2">
<li>编辑<code>/var/kerberos/krb5kdc/kadm5.acl</code>配置文件确定哪些主体具有对Kerberos数据库的管理访问权限</li>
</ol>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">*/admin@HADOOP.COM</span> <span class="string">*</span></span><br></pre></td></tr></table></figure>

<ol start="3">
<li>使用<code>kdb5_util</code>创建数据库</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kdb5_util create -s -r HADOOP.COM</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>启动Kerberos</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">systemctl start krb5kdc.service </span><br><span class="line">systemctl start kadmin.service</span><br></pre></td></tr></table></figure>

<ol start="5">
<li>使用<code>kadmin.local</code>命令为主KDC的主机服务创建新主体,并创建管理员主体</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">kadmin.local 进入交互命令行</span><br><span class="line"></span><br><span class="line">addprinc -randkey host/henghe-227</span><br><span class="line"></span><br><span class="line">//使用ktadd命令为服务设置一个随机密钥，并将该随机密钥存储在主服务器的默认密钥表文件中</span><br><span class="line">ktadd host/henghe-227</span><br><span class="line"></span><br><span class="line">//创建管理员主体</span><br><span class="line">addprinc root/admin</span><br></pre></td></tr></table></figure>

<ol start="6">
<li>将Master上的Kerberos配置文件scp到Slaves上</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">scp /etc/krb5.conf henghe-228:/etc/</span><br><span class="line">scp /var/kerberos/krb5kdc/.k5.HADOOP.COM henghe-228:/var/kerberos/krb5kdc/</span><br><span class="line">scp /var/kerberos/krb5kdc/kadm5.acl henghe-228:/var/kerberos/krb5kdc/</span><br><span class="line">scp /var/kerberos/krb5kdc/kdc.conf henghPe-228:/var/kerberos/krb5kdc/</span><br></pre></td></tr></table></figure>


<h5 id="Slaves端"><a href="#Slaves端" class="headerlink" title="Slaves端"></a>Slaves端</h5><ol>
<li>使用<code>kadmin</code>命令认证root/admin密码进入交互命令行，为备KDC的主机服务创建新主体</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">kadmin 输入root/admin密码，进入交互命令行</span><br><span class="line"></span><br><span class="line">addprinc -randkey host/henghe-228</span><br><span class="line"></span><br><span class="line">//使用ktadd命令为服务设置一个随机密钥，并将该随机密钥存储在主服务器的默认密钥表文件中</span><br><span class="line">ktadd host/henghe-228</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>添加配置文件<code>/var/kerberos/krb5kdc/kpropd.acl</code></li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">//将主KDC的主机服务名称添加到该文件</span><br><span class="line">host/henghe-227@HADOOP.COM</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>启动kprop服务</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl start kprop</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>将主KDC上的领域数据库转储到<code>kprop</code>命令将读取的默认数据文件(<code>/var/kerberos/krb5kdc/slave_datatrans</code>),来执行手动数据库传播 [Master上执行]</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kdb5_util dump /var/kerberos/krb5kdc/slave_datatrans</span><br></pre></td></tr></table></figure>

<ol start="5">
<li>使用<code>kprop</code>命令将其内容传输到服务KDC [Master上执行]</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kprop henghe-228</span><br></pre></td></tr></table></figure>

<ol start="6">
<li>Slaves端启动KDC</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl start krb5kdc</span><br></pre></td></tr></table></figure>

<ol start="7">
<li>将<code>/etc/krb5.conf</code>客户端应在其的KDC的名单只列出次级KDC进行测试</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">/etc/krb5.conf配置文件中 多加上一个KDC的地址</span><br><span class="line"></span><br><span class="line">kdc = henghe-228</span><br></pre></td></tr></table></figure>

<ol start="8">
<li>创建一个脚本，该脚本转储领域数据库并运行kprop命令以依次将数据库传输到每个辅助KDC，并配置cron服务以定期运行该脚本(kprop_tran.sh)</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">#!/bin/bash</span><br><span class="line"></span><br><span class="line">DUMP=/var/kerberos/krb5kdc/slave_datatrans</span><br><span class="line">TIMESTAMP=`date`</span><br><span class="line"></span><br><span class="line">echo &quot;Start $TIMESTAMP&quot;</span><br><span class="line">kdb5_util dump $DUMP</span><br><span class="line">kprop henghe-228</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">//定时任务设置</span><br><span class="line">*/2 * * * * /opt/kprop_tran.sh</span><br></pre></td></tr></table></figure>

<h2 id="Ranger开启Kerberos"><a href="#Ranger开启Kerberos" class="headerlink" title="Ranger开启Kerberos"></a>Ranger开启Kerberos</h2><ol>
<li>创建所需的Principal</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">addprinc -randkey HTTP/henghe-034@HADOOP.COM</span><br><span class="line">addprinc -randkey ranger/henghe-034@HADOOP.COM</span><br><span class="line">addprinc -randkey rangerlookup/henghe-034@HADOOP.COM</span><br><span class="line"></span><br><span class="line">xst -k http.service.keytab HTTP/henghe-034@HADOOP.COM</span><br><span class="line">xst -k ranger.service.keytab ranger/henghe-034@HADOOP.COM</span><br><span class="line">xst -k lookup.keytab rangerlookup/henghe-034@HADOOP.COM</span><br><span class="line"></span><br><span class="line">//rangerloopup Principal作用</span><br><span class="line">由于开启Kerberos之后，RangerAdmin使用rangerlookup/hostname@HADOOP.COM去访问服务,</span><br><span class="line">在新建服务的时候会把rangerlookup加入到默认创建出来的策略中，作为超级用户使用</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>修改配置文件 install.properties</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">#------------ Kerberos Config -----------------</span><br><span class="line">// hadoop_conf不指定就需要修改ranger-admin自带的core-site.xml</span><br><span class="line">spnego_principal=HTTP/henghe-034@HADOOP.COM</span><br><span class="line">spnego_keytab=/opt/keytab/http.service.keytab</span><br><span class="line">token_valid=30</span><br><span class="line">cookie_domain=henghe-034</span><br><span class="line">cookie_path=/</span><br><span class="line">admin_principal=ranger/henghe-034@HADOOP.COM</span><br><span class="line">admin_keytab=/opt/keytab/ranger.service.keytab</span><br><span class="line">lookup_principal=rangerlookup/henghe-034@HADOOP.COM</span><br><span class="line">lookup_keytab=/opt/keytab/lookup.keytab</span><br><span class="line">hadoop_conf=</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>修改配置文件 core-site.xml</li>
</ol>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">// pwd : /opt/ranger-admin/ews/webapp/WEB-INF/classes/conf/core-site.xml</span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">name</span>&gt;</span>hadoop.security.authentication<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">value</span>&gt;</span>kerberos<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">name</span>&gt;</span>hadoop.security.auth_to_local<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">value</span>&gt;</span></span><br><span class="line">    DEFAULT</span><br><span class="line">  <span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br></pre></td></tr></table></figure>


<h2 id="HDFS开启Kerberos"><a href="#HDFS开启Kerberos" class="headerlink" title="HDFS开启Kerberos"></a>HDFS开启Kerberos</h2><h3 id="HDFS配置"><a href="#HDFS配置" class="headerlink" title="HDFS配置"></a>HDFS配置</h3><ol>
<li>创建使用的Principal</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">addprinc -randkey hdfs/henghe-032@HADOOP.COM</span><br><span class="line">addprinc -randkey hdfs/henghe-033@HADOOP.COM</span><br><span class="line">addprinc -randkey hdfs/henghe-034@HADOOP.COM</span><br><span class="line">addprinc -randkey HTTP/henghe-032@HADOOP.COM</span><br><span class="line">addprinc -randkey HTTP/henghe-033@HADOOP.COM</span><br><span class="line">addprinc -randkey HTTP/henghe-034@HADOOP.COM</span><br><span class="line"></span><br><span class="line">xst -k hdfs.service.keytab hdfs/henghe-032@HADOOP.COM</span><br><span class="line">xst -k hdfs.service.keytab hdfs/henghe-033@HADOOP.COM</span><br><span class="line">xst -k hdfs.service.keytab hdfs/henghe-034@HADOOP.COM</span><br><span class="line">xst -k http.service.keytab HTTP/henghe-032@HADOOP.COM</span><br><span class="line">xst -k http.service.keytab HTTP/henghe-033@HADOOP.COM</span><br><span class="line">xst -k http.service.keytab HTTP/henghe-034@HADOOP.COM</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>HDFS配置文件</li>
</ol>
<p><strong>core-site.xml</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">&lt;configuration&gt;</span><br><span class="line">    &lt;property&gt;</span><br><span class="line">      &lt;name&gt;hadoop.security.authentication&lt;/name&gt;</span><br><span class="line">      &lt;value&gt;kerberos&lt;/value&gt;</span><br><span class="line">    &lt;/property&gt;</span><br><span class="line">    &lt;property&gt;</span><br><span class="line">      &lt;name&gt;hadoop.security.authorization&lt;/name&gt;</span><br><span class="line">      &lt;value&gt;true&lt;/value&gt;</span><br><span class="line">    &lt;/property&gt;</span><br><span class="line">    &lt;property&gt;</span><br><span class="line">      &lt;name&gt;hadoop.security.auth_to_local&lt;/name&gt;</span><br><span class="line">      &lt;value&gt;</span><br><span class="line">        DEFAULT</span><br><span class="line">      &lt;/value&gt;</span><br><span class="line">    &lt;/property&gt;</span><br><span class="line">&lt;/configuration&gt;</span><br></pre></td></tr></table></figure>

<p><strong>hdfs-site.xml</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line">&lt;configuration&gt;</span><br><span class="line">    &lt;property&gt;</span><br><span class="line">      &lt;name&gt;dfs.block.access.token.enable&lt;/name&gt;</span><br><span class="line">      &lt;value&gt;true&lt;/value&gt;</span><br><span class="line">    &lt;/property&gt;</span><br><span class="line">    &lt;property&gt;  </span><br><span class="line">      &lt;name&gt;dfs.datanode.data.dir.perm&lt;/name&gt;  </span><br><span class="line">      &lt;value&gt;700&lt;/value&gt;  </span><br><span class="line">    &lt;/property&gt;</span><br><span class="line">    </span><br><span class="line">    &lt;property&gt;</span><br><span class="line">      &lt;name&gt;dfs.namenode.keytab.file&lt;/name&gt;</span><br><span class="line">      &lt;value&gt;/opt/keytab/hdfs.service.keytab&lt;/value&gt;</span><br><span class="line">    &lt;/property&gt;</span><br><span class="line">    &lt;property&gt;</span><br><span class="line">      &lt;name&gt;dfs.namenode.kerberos.principal&lt;/name&gt;</span><br><span class="line">      &lt;value&gt;hdfs/_HOST@HADOOP.COM&lt;/value&gt;</span><br><span class="line">    &lt;/property&gt;</span><br><span class="line">    &lt;property&gt;</span><br><span class="line">      &lt;name&gt;dfs.namenode.kerberos.internal.spnego.principal&lt;/name&gt;</span><br><span class="line">      &lt;value&gt;HTTP/_HOST@HADOOP.COM&lt;/value&gt;</span><br><span class="line">    &lt;/property&gt;</span><br><span class="line">    </span><br><span class="line">    &lt;property&gt;</span><br><span class="line">      &lt;name&gt;dfs.datanode.keytab.file&lt;/name&gt;</span><br><span class="line">      &lt;value&gt;/opt/keytab/hdfs.service.keytab&lt;/value&gt;</span><br><span class="line">    &lt;/property&gt;</span><br><span class="line">    &lt;property&gt;</span><br><span class="line">      &lt;name&gt;dfs.datanode.kerberos.principal&lt;/name&gt;</span><br><span class="line">      &lt;value&gt;hdfs/_HOST@HADOOP.COM&lt;/value&gt;</span><br><span class="line">    &lt;/property&gt;</span><br><span class="line">    </span><br><span class="line">    &lt;property&gt;</span><br><span class="line">      &lt;name&gt;dfs.datanode.address&lt;/name&gt;</span><br><span class="line">      &lt;value&gt;0.0.0.0:1004&lt;/value&gt;</span><br><span class="line">    &lt;/property&gt;</span><br><span class="line">    &lt;property&gt;</span><br><span class="line">      &lt;name&gt;dfs.datanode.http.address&lt;/name&gt;</span><br><span class="line">      &lt;value&gt;0.0.0.0:1006&lt;/value&gt;</span><br><span class="line">    &lt;/property&gt;</span><br><span class="line">    &lt;property&gt;</span><br><span class="line">      &lt;name&gt;dfs.datanode.https.address&lt;/name&gt;</span><br><span class="line">      &lt;value&gt;0.0.0.0:50470&lt;/value&gt;</span><br><span class="line">    &lt;/property&gt;</span><br><span class="line"></span><br><span class="line">    &lt;property&gt;</span><br><span class="line">      &lt;name&gt;dfs.journalnode.keytab.file&lt;/name&gt;</span><br><span class="line">      &lt;value&gt;/opt/keytab/hdfs.service.keytab&lt;/value&gt;</span><br><span class="line">    &lt;/property&gt;</span><br><span class="line">    &lt;property&gt;</span><br><span class="line">      &lt;name&gt;dfs.journalnode.kerberos.principal&lt;/name&gt;</span><br><span class="line">      &lt;value&gt;hdfs/_HOST@HADOOP.COM&lt;/value&gt;</span><br><span class="line">    &lt;/property&gt;</span><br><span class="line">    &lt;property&gt;</span><br><span class="line">      &lt;name&gt;dfs.journalnode.kerberos.internal.spnego.principal&lt;/name&gt;</span><br><span class="line">      &lt;value&gt;HTTP/_HOST@HADOOP.COM&lt;/value&gt;</span><br><span class="line">    &lt;/property&gt;</span><br><span class="line"></span><br><span class="line">    &lt;property&gt;</span><br><span class="line">      &lt;name&gt;dfs.journalnode.https-address&lt;/name&gt;</span><br><span class="line">      &lt;value&gt; 0.0.0.0:8481&lt;/value&gt;</span><br><span class="line">    &lt;/property&gt;</span><br><span class="line"></span><br><span class="line">    &lt;property&gt;</span><br><span class="line">      &lt;name&gt;dfs.webhdfs.enabled&lt;/name&gt;</span><br><span class="line">      &lt;value&gt;true&lt;/value&gt;</span><br><span class="line">    &lt;/property&gt;</span><br><span class="line">    &lt;property&gt;</span><br><span class="line">      &lt;name&gt;dfs.web.authentication.kerberos.principal&lt;/name&gt;</span><br><span class="line">      &lt;value&gt;HTTP/_HOST@HADOOP.COM&lt;/value&gt;</span><br><span class="line">    &lt;/property&gt;</span><br><span class="line">    &lt;property&gt;</span><br><span class="line">      &lt;name&gt;dfs.web.authentication.kerberos.keytab&lt;/name&gt;</span><br><span class="line">      &lt;value&gt;/opt/keytab/http.service.keytab&lt;/value&gt;</span><br><span class="line">    &lt;/property&gt; </span><br><span class="line">&lt;/configuration&gt;</span><br></pre></td></tr></table></figure>

<p><strong>hadoop-env.sh</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">export JAVA_HOME=/opt/java/jdk1.8</span><br><span class="line">export HADOOP_HOME=/opt/hadoop</span><br><span class="line"></span><br><span class="line">export HADOOP_SECURE_DN_USER=hdfs</span><br><span class="line">export JSVC_HOME=/opt/hadoop/libexec</span><br></pre></td></tr></table></figure>

<h3 id="配置JSVC"><a href="#配置JSVC" class="headerlink" title="配置JSVC"></a>配置JSVC</h3><ol>
<li>下载并解压</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">wget https://mirror.bit.edu.cn/apache/commons/daemon/binaries/commons-daemon-1.2.2-bin.tar.gz</span><br><span class="line">wget https://mirror.bit.edu.cn/apache/commons/daemon/source/commons-daemon-1.2.2-src.tar.gz</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>编译生成JSVC</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cd /opt/commons-daemon-1.2.2-src/src/native/unix</span><br><span class="line">./configure</span><br><span class="line">make</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>分发JSVC和JSVC依赖包</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">cd /opt/commons-daemon-1.2.2-src/src/native/unix</span><br><span class="line">cp jsvc /opt/hadoop/libexec</span><br><span class="line">rm -rf /opt/hadoop/share/hadoop/hdfs/lib/commons-daemon-*.jar</span><br><span class="line">cp /opt/commons-daemon-1.2.2/commons-daemon-1.2.2.jar /opt/hadoop/share/hadoop/hdfs/lib/</span><br></pre></td></tr></table></figure>

<h3 id="问题记录"><a href="#问题记录" class="headerlink" title="问题记录"></a>问题记录</h3><ol>
<li>org.apache.hadoop.ipc.RemoteException(javax.securi ty.sasl.SaslException): GSS initiate failed</li>
</ol>
<p><code>更换JCE LIB</code></p>
<ol start="2">
<li>认证失败 </li>
</ol>
<p><code>大多数都是principal被更改导致密码变化 无法进行认证</code></p>
<ol start="3">
<li>hadoop集成kerberos后，运行命令，报org.apache.hadoop.security.AccessControlException</li>
</ol>
<p><code>将krb5.conf文件中的default_ccache_name注释掉，然后执行kdestroy,重新kinit</code></p>
<h2 id="YARN开启Kerberos"><a href="#YARN开启Kerberos" class="headerlink" title="YARN开启Kerberos"></a>YARN开启Kerberos</h2><ol>
<li>创建principal</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">addprinc -randkey yarn/henghe-032@HADOOP.COM</span><br><span class="line">addprinc -randkey yarn/henghe-033@HADOOP.COM</span><br><span class="line">addprinc -randkey yarn/henghe-034@HADOOP.COM</span><br><span class="line"></span><br><span class="line">xst -k yarn.service.keytab yarn/henghe-032@HADOOP.COM</span><br><span class="line">xst -k yarn.service.keytab yarn/henghe-033@HADOOP.COM</span><br><span class="line">xst -k yarn.service.keytab yarn/henghe-034@HADOOP.COM</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>修改配置文件(yarn-site.xml)</li>
</ol>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">name</span>&gt;</span>yarn.resourcemanager.keytab<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">value</span>&gt;</span>/opt/keytab/yarn.service.keytab<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">name</span>&gt;</span>yarn.resourcemanager.principal<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">value</span>&gt;</span>yarn/_HOST@HADOOP.COM<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">name</span>&gt;</span>yarn.nodemanager.keytab<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">value</span>&gt;</span>/opt/keytab/yarn.service.keytab<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">name</span>&gt;</span>yarn.nodemanager.principal<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">value</span>&gt;</span>yarn/_HOST@HADOOP.COM<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">name</span>&gt;</span>yarn.nodemanager.container-executor.class<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">value</span>&gt;</span>org.apache.hadoop.yarn.server.nodemanager.LinuxContainerExecutor<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">name</span>&gt;</span>yarn.nodemanager.linux-container-executor.group<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">value</span>&gt;</span>hadoop<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">name</span>&gt;</span>yarn.timeline-service.keytab<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">value</span>&gt;</span>/opt/keytab/yarn.service.keytab<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">name</span>&gt;</span>yarn.timeline-service.principal<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">value</span>&gt;</span>yarn/_HOST@HADOOP.COM<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">开启Kerberos后container-executor切换为LinuxContainerExecutor，为什么需要重新编译？</span><br><span class="line"></span><br><span class="line">1. container-executor默认是DefaultContainerExecutor，是以起Nodemanager的用户身份启动container的，切换为LinuxContainerExecutor会以提交application的用户身份来启动，它使用一个setuid可执行文件来启动和销毁container</span><br><span class="line">2. 这个可执行文件在bin/container-executor，需要重新编译，container-executor还需要一个配置文件container-executor.cfg。而且这个配置文件和container-executor的二进制文件相对路径是固定的。默认情况下container-executor会去../etc/hadoop路径下寻找配置文件，找不到的话会报错</span><br><span class="line">3. 切换LinuxContainerExecutor后，container-executor和container-executor.cfg的所有者必须是root。而且他们所在的目录一直上溯到/，所有者也必须是root。所以我们一般把这两个文件放在/etc下</span><br><span class="line">4. container-executor文件的权限必须是6050 or --Sr-s---，因为它的原理就是setuid/setgid</span><br><span class="line">5. group owner必须和启动NM的用户同组。比如NM由yarn用户启动，yarn用户属于hadoop组，那container-executor必须也是hadoop组</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>添加配置文件(/etc/container-executor.cfg)</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">#运行container的用户</span><br><span class="line">yarn.nodemanager.linux-container-executor.group=hadoop</span><br><span class="line">#这个是不允许运行应用的用户列表，默认是全部可以运行</span><br><span class="line">banned.users=banneduser</span><br><span class="line">#这个是允许提交job的最小的userid的值。CentOS中一般用户的id在500以上。</span><br><span class="line">min.user.id=500</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>替换container-executor,并给新文件授权</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">将编译之后的container-executor放在/opt/hadoop/bin下，创建/etc/container-executor.cfg</span><br><span class="line">container-executor.cfg配置见上面</span><br><span class="line"></span><br><span class="line">给container-executor和container-executor.cfg赋权限</span><br><span class="line">chown root:hadoop /opt/hadoop/bin/container-executor</span><br><span class="line">chmod 6050 /opt/hadoop/bin/container-executor</span><br><span class="line">chown root:hadoop /etc/container-executor.cfg</span><br><span class="line">chmod 0400 /etc/container-executor.cfg</span><br><span class="line"></span><br><span class="line">[yarn.nodemanager.local-dirs],[yarn.nodemanager.log-dirs]配置项的文件夹都设置为775权限</span><br><span class="line"></span><br><span class="line">NodeManager节点下 ：</span><br><span class="line">chown -R yarn:hadoop /opt/hadoop/logs/userlogs</span><br><span class="line">chmod 775 /opt/hadoop/logs/userlogs</span><br></pre></td></tr></table></figure>

<ol start="5">
<li>修改配置文件(mapred-site.xml)</li>
</ol>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">name</span>&gt;</span>mapreduce.jobhistory.keytab<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">value</span>&gt;</span>/opt/keytab/yarn.service.keytab<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">name</span>&gt;</span>mapreduce.jobhistory.principal<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">value</span>&gt;</span>yarn/_HOST@HADOOP.COM<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ol start="6">
<li>启动 ：<code>yarn --daemon</code></li>
</ol>
<h2 id="Hive开启Kerberos"><a href="#Hive开启Kerberos" class="headerlink" title="Hive开启Kerberos"></a>Hive开启Kerberos</h2><ol>
<li>添加Principal,导出Keytab</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">addprinc -randkey hive/henghe-032@HADOOP.COM</span><br><span class="line">addprinc -randkey hive/henghe-033@HADOOP.COM</span><br><span class="line"></span><br><span class="line">xst -k hive.service.keytab hive/henghe-032@HADOOP.COM</span><br><span class="line">xst -k hive.service.keytab hive/henghe-033@HADOOP.COM</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>修改配置文件(hive-site.xml)</li>
</ol>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">name</span>&gt;</span>hive.server2.authentication<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">value</span>&gt;</span>KERBEROS<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">name</span>&gt;</span>hive.metastore.sasl.enabled<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">value</span>&gt;</span>true<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">name</span>&gt;</span>hive.server2.authentication.kerberos.principal<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">value</span>&gt;</span>hive/_HOST@HADOOP.COM<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">name</span>&gt;</span>hive.server2.authentication.kerberos.keytab<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">value</span>&gt;</span>/opt/keytab/hive.service.keytab<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">name</span>&gt;</span>hive.metastore.kerberos.principal<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">value</span>&gt;</span>hive/_HOST@HADOOP.COM<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">name</span>&gt;</span>hive.metastore.kerberos.keytab.file<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">value</span>&gt;</span>/opt/keytab/hive.service.keytab<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">name</span>&gt;</span>hive.server2.enable.doAs<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">value</span>&gt;</span>true<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ol start="3">
<li>测试beeline连接</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">kinit hive</span><br><span class="line"></span><br><span class="line">beeline</span><br><span class="line">!connect jdbc:hive2://henghe-032:10000/;principal=hive/henghe-228@HADOOP.COM</span><br><span class="line"></span><br><span class="line">HA : !connect jdbc:hive2://henghe-032:2181,henghe-033:2181,henghe-034:2181/;serviceDiscoveryMode=zooKeeper;zooKeeperNamespace=hiveserver2_zk;principal=hive/henghe-032@HADOOP.COM</span><br><span class="line"></span><br><span class="line">注：此处的principal需要添加的是Hive启动时候的Principal</span><br></pre></td></tr></table></figure>

<h2 id="Zookeeper开启Kerberos"><a href="#Zookeeper开启Kerberos" class="headerlink" title="Zookeeper开启Kerberos"></a>Zookeeper开启Kerberos</h2><ol>
<li>创建principal，导出keytab</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">addprinc -randkey zookeeper/henghe-032@HADOOP.COM</span><br><span class="line">addprinc -randkey zookeeper/henghe-033@HADOOP.COM</span><br><span class="line">addprinc -randkey zookeeper/henghe-034@HADOOP.COM</span><br><span class="line"></span><br><span class="line">xst -k zk.service.keytab zookeeper/henghe-032@HADOOP.COM</span><br><span class="line">xst -k zk.service.keytab zookeeper/henghe-033@HADOOP.COM</span><br><span class="line">xst -k zk.service.keytab zookeeper/henghe-034@HADOOP.COM</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>修改配置文件(zoo.cfg)[所有ZK服务端]</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">authProvider.1=org.apache.zookeeper.server.auth.SASLAuthenticationProvider</span><br><span class="line">jaasLoginRenew=3600000</span><br><span class="line">#kerberos.removeHostFromPrincipal=true</span><br><span class="line">#kerberos.removeRealmFromPrincipal=true</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>创建配置文件(../zookeeper/conf/java.env)[所有ZK服务端]</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">export JVMFLAGS=&quot;-Djava.security.auth.login.config=/opt/zookeeper/conf/jaas.conf&quot;</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>创建配置文件(../zookeeper/conf/jaas.conf)</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">Server &#123;</span><br><span class="line">  com.sun.security.auth.module.Krb5LoginModule required</span><br><span class="line">  useKeyTab=true</span><br><span class="line">  keyTab=&quot;/opt/zookeeper/zookeeper.keytab&quot;</span><br><span class="line">  storeKey=true</span><br><span class="line">  useTicketCache=true</span><br><span class="line">  //不同服务端填写不同主机</span><br><span class="line">  principal=&quot;zookeeper/henghe-032@HADOOP.COM&quot;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<ol start="5">
<li>启动Zookeeper服务 : <code>zkServer.sh start</code></li>
</ol>
<h2 id="HBase开启Kerberos"><a href="#HBase开启Kerberos" class="headerlink" title="HBase开启Kerberos"></a>HBase开启Kerberos</h2><ol>
<li>创建principal,导出keytab</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">addprinc -randkey hbase/henghe-032@HADOOP.COM</span><br><span class="line">addprinc -randkey hbase/henghe-033@HADOOP.COM</span><br><span class="line">addprinc -randkey hbase/henghe-034@HADOOP.COM</span><br><span class="line"></span><br><span class="line">xst -k hbase.service.keytab hbase/henghe-032@HADOOP.COM</span><br><span class="line">xst -k hbase.service.keytab hbase/henghe-033@HADOOP.COM</span><br><span class="line">xst -k hbase.service.keytab hbase/henghe-034@HADOOP.COM</span><br><span class="line"></span><br><span class="line">addprinc -randkey hbaseclient/zookeeper@HADOOP.COM</span><br><span class="line"></span><br><span class="line">xst -k hbase.zkClient.keytab hbaseclient/zookeeper@HADOOP.COM</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>修改配置文件(hbase-env.sh)</li>
</ol>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">export</span> HBASE_OPTS=<span class="string">"<span class="variable">$HBASE_OPTS</span> -XX:+UseConcMarkSweepGC -Djava.security.auth.login.config=/opt/hbase/conf/zk-jaas.conf"</span></span><br></pre></td></tr></table></figure>

<ol start="3">
<li>修改配置文件(base-site.xml)</li>
</ol>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--原生HBase--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>hbase.security.authentication<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">value</span>&gt;</span>kerberos<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>hbase.security.authorization<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">value</span>&gt;</span>true<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>hbase.regionserver.kerberos.principal<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">value</span>&gt;</span>hbase/_HOST@HADOOP.COM<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>hbase.regionserver.keytab.file<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">value</span>&gt;</span>/opt/keytab/hbase.service.keytab<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>hbase.master.kerberos.principal<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">value</span>&gt;</span>hbase/_HOST@HADOOP.COM<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>hbase.master.keytab.file<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">value</span>&gt;</span>/opt/keytab/hbase.service.keytab<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">name</span>&gt;</span>hbase.thrift.keytab.file<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">value</span>&gt;</span>/opt/keytab/hbase.service.keytab<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>hbase.thrift.kerberos.principal<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">value</span>&gt;</span>hbase/_HOST@HADOOP.COM<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">name</span>&gt;</span>hbase.thrift.dns.interface<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">value</span>&gt;</span>default<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">name</span>&gt;</span>hbase.thrift.dns.nameserver<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">value</span>&gt;</span>default<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--henghe需要添加的配置--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>henghe.security.authentication<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">value</span>&gt;</span>false<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">name</span>&gt;</span>hbase.client.userprovider.class<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">value</span>&gt;</span>org.apache.hadoop.hbase.security.UserProvider<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ol start="4">
<li>conf文件夹下添加zookeeper client配置</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Client &#123;</span><br><span class="line">      com.sun.security.auth.module.Krb5LoginModule required</span><br><span class="line">      useKeyTab=true</span><br><span class="line">      useTicketCache=false</span><br><span class="line">      keyTab=&quot;/opt/keytab/hbase.zkClient.keytab&quot;</span><br><span class="line">      principal=&quot;hbaseclient/zookeeper@HADOOP.COM&quot;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<ol start="5">
<li>启动 : <code>hbase-daemon.sh start master/regionserver</code></li>
</ol>
<h2 id="Kafka开启Kerberos"><a href="#Kafka开启Kerberos" class="headerlink" title="Kafka开启Kerberos"></a>Kafka开启Kerberos</h2><ol>
<li>创建principal,导出keytab</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">addprinc -randkey kafka/henghe-032@HADOOP.COM</span><br><span class="line">addprinc -randkey kafka/henghe-033@HADOOP.COM</span><br><span class="line"></span><br><span class="line">xst -k kafka.service.keytab kafka/henghe-032@HADOOP.COM</span><br><span class="line">xst -k kafka.service.keytab kafka/henghe-033@HADOOP.COM</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>修改配置文件(server.properties)</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">advertised.listeners=SASL_PLAINTEXT://henghe-032:9092</span><br><span class="line">security.inter.broker.protocol = SASL_PLAINTEXT</span><br><span class="line">sasl.mechanism.inter.broker.protocol = GSSAPI</span><br><span class="line">sasl.enabled.mechanisms = GSSAPI</span><br><span class="line">sasl.kerberos.service.name = kafka</span><br><span class="line">listeners=SASL_PLAINTEXT://henghe-032:9092</span><br><span class="line"></span><br><span class="line">//注 : sasl.kerberos.service.name这个设置的是什么name，创建服务端使用的Principal的时候就要创建什么name</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>添加配置文件(client.properties)</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">security.protocol=SASL_PLAINTEXT</span><br><span class="line">sasl.kerberos.service.name=kafka</span><br><span class="line">sasl.mechanism=GSSAPI</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>修改脚本文件(bin目录下Kafka-run-class)</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">KAFKA_JVM_PERFORMANCE_OPTS=&quot;$KAFKA_JVM_PERFORMANCE_OPTS -Djava.security.krb5.conf=/etc/krb5.conf $KAFKA_JAAS&quot;</span><br><span class="line"></span><br><span class="line">//不要添加到最后，260到290行之间</span><br><span class="line"></span><br><span class="line">/*</span><br><span class="line">注 : $KAFKA_JAAS这个代表的是-Djava.security.auth.login.config=/opt/kafka/config/kafka_server_jaas.conf</span><br><span class="line">这个代表的是Kafka启动Server或是Client端所使用的Kerberos认证keytab文件</span><br><span class="line">写成变量的原因是如果直接写在这里服务端使用的keytab认证文件，那么如果有Client端也在这台主机上，那么就无法进行认证了，所以写成变量形式</span><br><span class="line">*/</span><br></pre></td></tr></table></figure>

<ol start="5">
<li>修改Kafka启动脚本文件(Kafka-server-start.sh)</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">export KAFKA_JAAS=&quot;-Djava.security.auth.login.config=/opt/kafka/config/kafka_server_jaas.conf&quot;</span><br><span class="line"></span><br><span class="line">//这就是将Kafka Server端启动时候用的Keytab认证文件写入</span><br></pre></td></tr></table></figure>

<ol start="6">
<li>启动 : <code>./bin/kafka-server-start.sh config/server.properties</code></li>
<li>认证用户</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">1. 创建Principal : addprinc wfy/kafkaUser@HADOOP.COM</span><br><span class="line">2. 导出Keytab : xst -k kafkauser.keytab wfy/kafkaUser@HADOOP.COM</span><br><span class="line">3. 创建kafka_client_jaas.conf</span><br><span class="line">KafkaClient &#123;</span><br><span class="line">        com.sun.security.auth.module.Krb5LoginModule required</span><br><span class="line">        useKeyTab=true</span><br><span class="line">        storeKey=true</span><br><span class="line">        keyTab=&quot;/opt/kafkauser.keytab&quot;</span><br><span class="line">  			principal=&quot;wfy/kafkaUser@HADOOP.COM&quot;;</span><br><span class="line">&#125;;</span><br><span class="line">4. 导入Client端JVM参数 : export KAFKA_JAAS=”-Djava.security.auth.login.config=/opt/kafka/config/kafka_client_jaas.conf”</span><br><span class="line">5. 执行命令</span><br></pre></td></tr></table></figure>

<ol start="8">
<li>命令</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Topic : kafka-topics.sh --create --zookeeper henghe-032:2181 --replication-factor 1 --partitions 1 --topic test</span><br><span class="line">Producer : kafka-console-producer.sh --broker-list henghe-032:9092 --topic test --producer.config /opt/kafka/config/client.properties</span><br><span class="line">Consumer : kafka-console-consumer.sh --bootstrap-server henghe-032:9092 --topic test --consumer.config /opt/kafka/config/client.properties</span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/02/10/Hadoop3-1-3%E5%AE%89%E8%A3%85%E8%AE%B0%E5%BD%95/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/xiaoniao.jpg">
      <meta itemprop="name" content="SmallBird">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="SmallBird`s Blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2020/02/10/Hadoop3-1-3%E5%AE%89%E8%A3%85%E8%AE%B0%E5%BD%95/" class="post-title-link" itemprop="url">Hadoop3.1.3安装记录(HA)</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-02-10 09:44:53" itemprop="dateCreated datePublished" datetime="2020-02-10T09:44:53+08:00">2020-02-10</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2020-03-11 17:53:00" itemprop="dateModified" datetime="2020-03-11T17:53:00+08:00">2020-03-11</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Hadoop/" itemprop="url" rel="index">
                    <span itemprop="name">Hadoop</span>
                  </a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="环境准备"><a href="#环境准备" class="headerlink" title="环境准备"></a>环境准备</h1><h2 id="集群节点信息"><a href="#集群节点信息" class="headerlink" title="集群节点信息"></a>集群节点信息</h2><p>三台机器 : </p>
<ul>
<li><p>henghe-032</p>
</li>
<li><p>henghe-033</p>
</li>
<li><p>henghe-034</p>
<h2 id="角色分配"><a href="#角色分配" class="headerlink" title="角色分配"></a>角色分配</h2><table>
<thead>
<tr>
<th align="center"></th>
<th align="center">NameNode</th>
<th align="center">DataNode</th>
<th align="center">ResourceManager</th>
<th align="center">NodeManager</th>
<th align="center">Journalnode</th>
<th align="center">ZKFC</th>
<th align="center">ZK</th>
</tr>
</thead>
<tbody><tr>
<td align="center">henghe-032</td>
<td align="center">*</td>
<td align="center">*</td>
<td align="center">*</td>
<td align="center">*</td>
<td align="center">*</td>
<td align="center">*</td>
<td align="center">*</td>
</tr>
<tr>
<td align="center">henghe-033</td>
<td align="center">*</td>
<td align="center">*</td>
<td align="center">*</td>
<td align="center">*</td>
<td align="center">*</td>
<td align="center"></td>
<td align="center">*</td>
</tr>
<tr>
<td align="center">henghe-034</td>
<td align="center"></td>
<td align="center">*</td>
<td align="center"></td>
<td align="center">*</td>
<td align="center">*</td>
<td align="center"></td>
<td align="center">*</td>
</tr>
</tbody></table>
<h2 id="环境变量设置"><a href="#环境变量设置" class="headerlink" title="环境变量设置"></a>环境变量设置</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">export HADOOP_HOME=/opt/hadoop</span><br><span class="line">export ZOOKEEPER_HOME=/opt/zookeeper</span><br><span class="line">export PATH=$PATH:JAVA_HOME/bin:$HADOOP_HOME/bin:$HADOOP_HOME/sbin:$ZOOKEEPER_HOME/bin</span><br></pre></td></tr></table></figure>

<h2 id="其他设置"><a href="#其他设置" class="headerlink" title="其他设置"></a>其他设置</h2><ul>
<li><p>Hosts文件配置</p>
</li>
<li><p>SSH免密配置</p>
</li>
</ul>
<h1 id="Zookeeper安装部署"><a href="#Zookeeper安装部署" class="headerlink" title="Zookeeper安装部署"></a>Zookeeper安装部署</h1><h2 id="安装步骤"><a href="#安装步骤" class="headerlink" title="安装步骤"></a>安装步骤</h2><ol>
<li><p>首先解压Zookeeper安装包</p>
</li>
<li><p>Zookeeper目录下创建zkdata文件夹,zkdata文件夹下创建myid文件</p>
</li>
<li><p>Zookeeper目录下conf目录下,更改zoo_sample.cfg文件为zoo.cfg文件</p>
</li>
<li><p>更改zoo.cfg文件,配置Zookeeper信息</p>
</li>
<li><p>将配置好的Zookeeper进行分发</p>
</li>
<li><p>启动Zookeeper</p>
</li>
</ol>
</li>
</ul>
<h2 id="Zoo-cfg配置文件"><a href="#Zoo-cfg配置文件" class="headerlink" title="Zoo.cfg配置文件"></a>Zoo.cfg配置文件</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">修改 : </span><br><span class="line">dataDir=/opt/zookeeper/zkdata</span><br><span class="line"></span><br><span class="line">添加 : </span><br><span class="line">server.1=henghe-032:2888:3888</span><br><span class="line">server.2=henghe-033:2888:3888</span><br><span class="line">server.3=henghe-034:2888:3888</span><br></pre></td></tr></table></figure>

<h2 id="启动Zookeeper"><a href="#启动Zookeeper" class="headerlink" title="启动Zookeeper"></a>启动Zookeeper</h2><p><strong>分发Zookeeper :</strong> <code>scp -r /opt/zookeeper henghe-033:/opt</code>  (henghe-034同理)</p>
<p><strong>启动Zookeeper :</strong> <code>zkServer.sh start</code></p>
<h1 id="Hadoop安装部署"><a href="#Hadoop安装部署" class="headerlink" title="Hadoop安装部署"></a>Hadoop安装部署</h1><p><strong>解压安装包,更改文件夹名称 :</strong> <code>mv hadoop-3.1.3 hadoop</code></p>
<h2 id="Hadoop配置文件"><a href="#Hadoop配置文件" class="headerlink" title="Hadoop配置文件"></a>Hadoop配置文件</h2><h3 id="hadoop-env-sh"><a href="#hadoop-env-sh" class="headerlink" title="hadoop.env.sh"></a>hadoop.env.sh</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">空白处添加 : </span><br><span class="line">export JAVA_HOME=</span><br></pre></td></tr></table></figure>

<h3 id="core-site-xml"><a href="#core-site-xml" class="headerlink" title="core-site.xml"></a>core-site.xml</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">name</span>&gt;</span>fs.defaultFS<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">value</span>&gt;</span>hdfs://master<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">name</span>&gt;</span>hadoop.tmp.dir<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">value</span>&gt;</span>/var/log/hadoop/ha<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">name</span>&gt;</span>ha.zookeeper.quorum<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">value</span>&gt;</span>henghe-032:2181,henghe-033:2181,henghe-034:2181<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">name</span>&gt;</span>hadoop.http.staticuser.user<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">value</span>&gt;</span>root<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="hdfs-site-xml"><a href="#hdfs-site-xml" class="headerlink" title="hdfs-site.xml"></a>hdfs-site.xml</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">name</span>&gt;</span>dfs.replication<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">value</span>&gt;</span>2<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">             <span class="tag">&lt;<span class="name">name</span>&gt;</span>dfs.nameservices<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">             <span class="tag">&lt;<span class="name">value</span>&gt;</span>master<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">name</span>&gt;</span>dfs.ha.namenodes.master<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">value</span>&gt;</span>nn1,nn2<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">name</span>&gt;</span>dfs.namenode.rpc-address.master.nn1<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">value</span>&gt;</span>henghe-032:8020<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">name</span>&gt;</span>dfs.namenode.rpc-address.master.nn2<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">value</span>&gt;</span>henghe-033:8020<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">name</span>&gt;</span>dfs.namenode.http-address.master.nn1<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">value</span>&gt;</span>henghe-032:9870<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">name</span>&gt;</span>dfs.namenode.http-address.master.nn2<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">value</span>&gt;</span>henghe-033:9870<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">name</span>&gt;</span>dfs.namenode.shared.edits.dir<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">value</span>&gt;</span>qjournal://henghe-032:8485;henghe-033:8485;henghe-034:8485/master<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">name</span>&gt;</span>dfs.client.failover.proxy.provider.master<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">value</span>&gt;</span>org.apache.hadoop.hdfs.server.namenode.ha.ConfiguredFailoverProxyProvider<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">name</span>&gt;</span>dfs.ha.fencing.methods<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">value</span>&gt;</span>sshfence<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">name</span>&gt;</span>dfs.ha.fencing.ssh.private-key-files<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">value</span>&gt;</span>/root/.ssh/id_rsa<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">name</span>&gt;</span>dfs.journalnode.edits.dir<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">value</span>&gt;</span>/var/log/hadoop/ha/journalnode<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">name</span>&gt;</span>dfs.ha.automatic-failover.enabled<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">value</span>&gt;</span>true<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="workers"><a href="#workers" class="headerlink" title="workers"></a>workers</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">henghe-032</span><br><span class="line">henghe-033</span><br><span class="line">henghe-034</span><br></pre></td></tr></table></figure>

<h3 id="mapred-site-xml"><a href="#mapred-site-xml" class="headerlink" title="mapred-site.xml"></a>mapred-site.xml</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">name</span>&gt;</span>mapreduce.framework.name<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">value</span>&gt;</span>yarn<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="yarn-site-xml"><a href="#yarn-site-xml" class="headerlink" title="yarn-site.xml"></a>yarn-site.xml</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">name</span>&gt;</span>yarn.resourcemanager.ha.enabled<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">value</span>&gt;</span>true<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">name</span>&gt;</span>yarn.resourcemanager.cluster-id<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">value</span>&gt;</span>yrc<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">name</span>&gt;</span>yarn.resourcemanager.ha.rm-ids<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">value</span>&gt;</span>rm1,rm2<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">name</span>&gt;</span>yarn.resourcemanager.hostname.rm1<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">value</span>&gt;</span>henghe-032<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">name</span>&gt;</span>yarn.resourcemanager.hostname.rm2<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">value</span>&gt;</span>henghe-033<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">name</span>&gt;</span>yarn.resourcemanager.zk-address<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">value</span>&gt;</span>henghe-032:2181,henghe-033:2181,henghe-034:2181<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">name</span>&gt;</span>yarn.nodemanager.aux-services<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">value</span>&gt;</span>mapreduce_shuffle<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">name</span>&gt;</span>yarn.log-aggregation-enable<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">value</span>&gt;</span>true<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">name</span>&gt;</span>yarn.log-aggregation.retain-seconds<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">value</span>&gt;</span>86400<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">name</span>&gt;</span>yarn.resourcemanager.recovery.enabled<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">value</span>&gt;</span>true<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">name</span>&gt;</span>yarn.resourcemanager.store.class<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">value</span>&gt;</span>org.apache.hadoop.yarn.server.resourcemanager.recovery.ZKRMStateStore<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="start-dfs-sh-stop-dfs-sh"><a href="#start-dfs-sh-stop-dfs-sh" class="headerlink" title="start-dfs.sh,stop-dfs.sh"></a>start-dfs.sh,stop-dfs.sh</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">HDFS_DATANODE_USER=root</span><br><span class="line">HADOOP_SECURE_DN_USER=hdfs</span><br><span class="line">HDFS_ZKFC_USER=root</span><br><span class="line">HDFS_JOURNALNODE_USER=root</span><br><span class="line">HDFS_NAMENODE_USER=root</span><br><span class="line">HDFS_SECONDARYNAMENODE_USER=root</span><br></pre></td></tr></table></figure>

<h3 id="start-yarn-sh-stop-yarn-sh"><a href="#start-yarn-sh-stop-yarn-sh" class="headerlink" title="start-yarn.sh,stop-yarn.sh"></a>start-yarn.sh,stop-yarn.sh</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">YARN_RESOURCEMANAGER_USER=root</span><br><span class="line">HADOOP_SECURE_DN_USER=yarn </span><br><span class="line">YARN_NODEMANAGER_USER=root</span><br></pre></td></tr></table></figure>

<h2 id="启动Hadoop"><a href="#启动Hadoop" class="headerlink" title="启动Hadoop"></a>启动Hadoop</h2><p><strong>按顺序启动Hadoop</strong></p>
<ol>
<li><p>启动所有JournalNode : <code>hadoop-daemon.sh start journalnode</code></p>
</li>
<li><p>henghe-032格式化NameNode主节点 : <code>hdfs namenode -format</code></p>
</li>
<li><p>henghe-032启动NameNode : <code>hadoop-daemon.sh start namenode</code></p>
</li>
<li><p>henghe-033复制NameNode的元数据 : <code>hdfs namenode -bootstrapStandby</code></p>
</li>
<li><p>henghe-032格式化ZKFC : <code>hdfs zkfc -formatZK</code></p>
</li>
<li><p>henghe-032启动剩余NameNode和所有DataNode : <code>start-dfs.sh</code></p>
</li>
<li><p>henghe-032启动ResourceManager和NodeManager : <code>start-yarn.sh</code></p>
</li>
<li><p>HDFS WebUI : <code>henghe-032:9870</code>,<code>henghe-033:9870</code></p>
</li>
<li><p>YARN WebUI : <code>henghe-032:8088</code></p>
</li>
</ol>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/01/09/%E9%97%AE%E9%A2%98%E8%AE%B0%E5%BD%95/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/xiaoniao.jpg">
      <meta itemprop="name" content="SmallBird">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="SmallBird`s Blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2020/01/09/%E9%97%AE%E9%A2%98%E8%AE%B0%E5%BD%95/" class="post-title-link" itemprop="url">问题记录</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-01-09 10:26:05" itemprop="dateCreated datePublished" datetime="2020-01-09T10:26:05+08:00">2020-01-09</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2020-05-11 20:32:40" itemprop="dateModified" datetime="2020-05-11T20:32:40+08:00">2020-05-11</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="问题记录"><a href="#问题记录" class="headerlink" title="问题记录"></a>问题记录</h1><h2 id="HBase"><a href="#HBase" class="headerlink" title="HBase"></a>HBase</h2><ol>
<li>Name or service not known</li>
</ol>
<ul>
<li><p>问题描述</p>
<ul>
<li>Hbase启动<code>start-hbase.sh</code>脚本发生Name or service not known异常</li>
</ul>
</li>
<li><p>解决方案</p>
<ul>
<li>查看regionservers文件是否被污染,如被污染删除手动创建</li>
</ul>
</li>
</ul>
<h2 id="Java"><a href="#Java" class="headerlink" title="Java"></a>Java</h2><ol>
<li>对List进行操作时报错java.lang.UnsupportedOperationException</li>
</ol>
<ul>
<li>问题描述<ul>
<li>对List进行操作时报错java.lang.UnsupportedOperationException，后来发现操作的List是由数组转换而成的</li>
</ul>
</li>
<li>解决方案<ul>
<li>调用Arrays.asList()生产的List的add、remove方法时报异常，这是由Arrays.asList() 返回的是Arrays的内部类ArrayList， 而不是java.util.ArrayList。Arrays的内部类ArrayList和java.util.ArrayList都是继承AbstractList，remove、add等方法AbstractList中是默认throw UnsupportedOperationException而且不作任何操作。java.util.ArrayList重新了这些方法而Arrays的内部类ArrayList没有重新，所以会抛出异常</li>
<li>List<String> list = Arrays.asList(array);</li>
<li>List arrList = new ArrayList(list);</li>
</ul>
</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/12/17/Apache-Ranger/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/xiaoniao.jpg">
      <meta itemprop="name" content="SmallBird">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="SmallBird`s Blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2019/12/17/Apache-Ranger/" class="post-title-link" itemprop="url">大数据安全之Apache Ranger</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2019-12-17 14:38:03" itemprop="dateCreated datePublished" datetime="2019-12-17T14:38:03+08:00">2019-12-17</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2020-06-22 16:06:06" itemprop="dateModified" datetime="2020-06-22T16:06:06+08:00">2020-06-22</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Ranger/" itemprop="url" rel="index">
                    <span itemprop="name">Ranger</span>
                  </a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>随着Hadoop生态系统越来越成熟,其现在能够支持完整的数据湖(Data Lake,是指来自多个不同来源的结构化或者非结构化数据,有选择地收集在多个数据库或者存储系统上)架构.企业在Hadoop系统上可以在多客户环境中运行多个工作负载.由于需要支持多用户访问企业数据湖,而数据对于企业来说是重要的资产,为了保护这些各种不同类型的用户的数据,专门应对大数据的分布式用户安全架构应运而生</p>
<h1 id="Apache-Ranger概述"><a href="#Apache-Ranger概述" class="headerlink" title="Apache Ranger概述"></a>Apache Ranger概述</h1><p>Apache Ranger是用于Hadoop的集中式安全管理解决方案,使管理员能够为HDFS和其他Hadoop平台组件创建和实施安全策略,并且为Hadoop的各个零部件提供细粒度的安全权限机制</p>
<h2 id="Ranger技术概况"><a href="#Ranger技术概况" class="headerlink" title="Ranger技术概况"></a>Ranger技术概况</h2><p>Apache Ranger是一个集中式安全管理框架,提供集中管理的安全策略和监控用户访问,而且它可以对Hadoop生态系统上的组件如Hive,Hbase等进行细粒度的数据访问控制,并解决授权和审计问题.通过操作Ranger Web UI控制台,管理员可以轻松地通过配置策略来控制用户访问权限.Ranger还提供全面的日志审计,使用户不仅能够清晰地看到请求信息和数据的权限状态,而且还能够通过基于Web UI管理控制台来配置访问权限.正如你看到任何一个企业级安全项目解决方案一样,Ranger通过LDAP/AD(轻量目录访问协议)支持同步用户和组的信息</p>
<p>为了实现用户和组的信息同步,Ranger集成了一个独立的守护进程模块,负责与LDAP/AD同步,并将策略分发到集群中的节点.轻量级代理程序嵌入在需要数据保护的单个Hadoop组件中,并使用这些组件中内置的安全挂钩.此代理还作为NameNode的一部分运行,为HDFS提供访问控制,并收集存储在审核日志中的请求详细信息.策略实施在本地层次节点上执行,这意味着Ranger在运行时间上没有显著的性能影响</p>
<p>Ranger通过在Hive1.3中使用标准的SQL授权,进一步与Hadoop进行深度集成,并且允许在表上使用SQL grant/revoke功能.此外,Ranger提供了一种模式,可以通过使用Hadoop文件级权限,验证HDFS中的访问.Ranger与基于Web的的管理控制台一起,支持策略管理的REST API.</p>
<p>Apache Ranger所做的是为Hadoop的每个部分和公共认证存储库提供插件,并允许用户在集中位置定义策略,实现权限控制.长期来说,Ranger已经涵盖Hadoop安全性方面的以下目标 : </p>
<ul>
<li><p>集中安全管理中心,管理在核心用户界面或者使用REST APIS过程中所有与安全相关的任务</p>
</li>
<li><p>使用Hadoop组件/工具进行特定操作的细粒度授权,通过中央工具进行管理</p>
</li>
<li><p>通过Hadoop组件来标准化授权方法</p>
</li>
<li><p>增强对不同授权方法的支持,如基于角色(role)的访问控制,或者基于属性的访问控制</p>
</li>
<li><p>集中Hadoop的所有组成部分的用户访问的审计和安全相关管理操作</p>
</li>
</ul>
<h2 id="Ranger特点及作用"><a href="#Ranger特点及作用" class="headerlink" title="Ranger特点及作用"></a>Ranger特点及作用</h2><h3 id="细粒度授权"><a href="#细粒度授权" class="headerlink" title="细粒度授权"></a>细粒度授权</h3><p>Ranger支持细粒度的管理,对Hadoop组件进行安全保护</p>
<table>
<thead>
<tr>
<th align="center">授权组件</th>
<th align="center">授权对象</th>
<th align="center">授权选项</th>
</tr>
</thead>
<tbody><tr>
<td align="center">HDFS</td>
<td align="center">分布式系统的资源路径</td>
<td align="center">读,写,执行</td>
</tr>
<tr>
<td align="center">HBase</td>
<td align="center">表,列族,列</td>
<td align="center">读,写,执行,admin</td>
</tr>
<tr>
<td align="center">Hive</td>
<td align="center">数据库,表,列</td>
<td align="center">select,update,create,drop,alter,index,lock</td>
</tr>
<tr>
<td align="center">YARN</td>
<td align="center">Queue</td>
<td align="center">admin-queue,submit-app</td>
</tr>
<tr>
<td align="center">Kafka</td>
<td align="center">Topic</td>
<td align="center">read,create,update,delete,all</td>
</tr>
</tbody></table>
<h3 id="集中化审计日志管理和策略管理"><a href="#集中化审计日志管理和策略管理" class="headerlink" title="集中化审计日志管理和策略管理"></a>集中化审计日志管理和策略管理</h3><p>所有的不同用户和组对安装Ranger的插件的Hadoop组件进行操作,都会生成一次该操作的日志</p>
<p>Ranger会更新策略,每次策略更新之前的策略信息那就都能查看到,原因在于更新策略会创建一个策略,该策略会替换原来的策略</p>
<h3 id="易于操作控制权限"><a href="#易于操作控制权限" class="headerlink" title="易于操作控制权限"></a>易于操作控制权限</h3><p>Ranger的强大之处在于,用户可以随时根据需求更改组件的权限,只需要在WEB UI中修改对应组件的策略即可</p>
<p>Ranger不仅支持在策略中设置条件允许的权限控制,而且还允许用户在策略中设置条件拒绝,从允许条件中排除和从拒绝条件中排除的权限控制</p>
<h3 id="统一的操作平台"><a href="#统一的操作平台" class="headerlink" title="统一的操作平台"></a>统一的操作平台</h3><p>Ranger把所有的组件的服务和策略的创建和更新都在Ranger Web UI上完成</p>
<p>Ranger安装各个组件的插件时,只需要修改相应的配置文件,就能使Ranger的权限控制功能失效</p>
<h3 id="全面支持Hadoop的组件"><a href="#全面支持Hadoop的组件" class="headerlink" title="全面支持Hadoop的组件"></a>全面支持Hadoop的组件</h3><p>Ranger已经可以支持Hadoop大部分核心组件,Storm和Solr需要在Kerberos条件下,才能进行权限控制</p>
<h2 id="Ranger架构"><a href="#Ranger架构" class="headerlink" title="Ranger架构"></a>Ranger架构</h2><p>Ranger安全认证机制的整体框架,主要包括Ranger Admin,Ranger Plugin和Ranger Usersync三部分</p>
<p><img src="Ranger%E6%9E%B6%E6%9E%84%E5%9B%BE.png" alt="Ranger架构图.png"></p>
<h3 id="Ranger-Admin"><a href="#Ranger-Admin" class="headerlink" title="Ranger Admin"></a>Ranger Admin</h3><p>Ranger Admin是安全管理的核心接口,也是Ranger框架的管理中心.用户可以在它提供的Web UI上管理系统用户权限,创建和更新权限认证策略,然后将这些策略存储在数据库中.每个组件的插件会定期监测这些策略.他还提供一个审计服务,可以收集存储在HDFS或者关系数据库中的数据并进行审计</p>
<h3 id="Ranger-Plugin"><a href="#Ranger-Plugin" class="headerlink" title="Ranger Plugin"></a>Ranger Plugin</h3><p>Ranger Plugin是权限安全管理的核心,它是一个轻量级的可以嵌入各个集群组件中的Java程序</p>
<p>例如 : Ranger对于其高度支持的Hive,提供一个可以嵌入Hive Server2服务中的插件,这个插件能从Ranger Admin中提取到关于Hive的所有权限认证策略,并将这些策略存储到本地文件中.当用户请求通过Hive组件时,这些插件会拦截请求,并安装认证策略进行评估,确认其是否符合设置的安全策略.插件会从用户请求中收集数据,将数据传输到审计服务器</p>
<h3 id="Ranger-Usersync"><a href="#Ranger-Usersync" class="headerlink" title="Ranger Usersync"></a>Ranger Usersync</h3><p>Ranger Usersync用于将用户/组从UNIX系统或LDAP同步到Ranger Admin</p>
<p>此独立进程也可以用作Ranger Admin的身份验证服务器,已使用Linux用户/密码登录到Ranger Admin</p>
<h2 id="Ranger安全及访问权限控制机制"><a href="#Ranger安全及访问权限控制机制" class="headerlink" title="Ranger安全及访问权限控制机制"></a>Ranger安全及访问权限控制机制</h2><p>访问权限无非是定义了”用户 - 资源 - 权限”这三者间的关系,Ranger基于策略来抽象这种关系,进而延伸出自己的权限模型</p>
<p><img src="Ranger%E6%9D%83%E9%99%90%E7%AD%96%E7%95%A5%E5%9B%BE.png" alt="Ranger权限策略图.png"></p>
<ul>
<li><p>用户 : 由User或Group来表达.User代表访问资源的用户,Group代表用户所属的用户组</p>
</li>
<li><p>资源 : 由(Service,Resource)二元组来表达,一条Policy唯一对应一个Service,但可以对应多个Resource</p>
</li>
<li><p>权限 : 由(AllowACL,DenyACL)二元组来表达,两者都包含两组AccessItem.而AccessItem则描述一组用户与一组访问之间的关系 — 在AllowACL中表示允许执行,而在DenyACL中表示拒绝执行</p>
</li>
</ul>
<h1 id="Apache-Ranger安装"><a href="#Apache-Ranger安装" class="headerlink" title="Apache Ranger安装"></a>Apache Ranger安装</h1><h2 id="Ranger编译"><a href="#Ranger编译" class="headerlink" title="Ranger编译"></a>Ranger编译</h2><h3 id="编译准备"><a href="#编译准备" class="headerlink" title="编译准备"></a>编译准备</h3><ol>
<li><p>安装Maven</p>
<p><em>maven阿里云镜像</em></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">mirror</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">id</span>&gt;</span>alimaven<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">name</span>&gt;</span>aliyun maven<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">url</span>&gt;</span>http://maven.aliyun.com/nexus/content/groups/public/<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">mirrorOf</span>&gt;</span>central<span class="tag">&lt;/<span class="name">mirrorOf</span>&gt;</span>       </span><br><span class="line"><span class="tag">&lt;/<span class="name">mirror</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>安装Git</p>
</li>
</ol>
<h3 id="编译"><a href="#编译" class="headerlink" title="编译"></a>编译</h3><p>下载源文件 : <code>git clone https://github.com/apache/ranger.git</code></p>
<p>编译源文件 : </p>
<ul>
<li><p><code>mvn clean</code></p>
</li>
<li><p><code>mvn -DskipTests=true clean compile package install assembly:assembly</code></p>
</li>
</ul>
<h2 id="Ranger-Admin安装"><a href="#Ranger-Admin安装" class="headerlink" title="Ranger Admin安装"></a>Ranger Admin安装</h2><h3 id="数据库初始化"><a href="#数据库初始化" class="headerlink" title="数据库初始化"></a>数据库初始化</h3><p>创建用户 : <code>CREATE USER &#39;ranger&#39;@&#39;%&#39; IDENTIFIED BY &#39;ranger&#39;;</code></p>
<p>创建数据库 : <code>create database ranger;</code></p>
<p>更改ROOT用户权限 : <code>UPDATE mysql.user SET Grant_priv=&#39;Y&#39;, Super_priv=&#39;Y&#39; WHERE User=&#39;root&#39;;</code></p>
<p>更改RANGER用户权限 : <code>UPDATE mysql.user SET Grant_priv=&#39;Y&#39;, Super_priv=&#39;Y&#39; WHERE User=&#39;ranger&#39;;</code></p>
<p>刷新权限 : <code>FLUSH PRIVILEGES;</code></p>
<h3 id="解压安装包"><a href="#解压安装包" class="headerlink" title="解压安装包"></a>解压安装包</h3><p><code>tar -zxvf ranger-1.2.0-admin.tar.gz -C /opt</code></p>
<p><code>mv /opt/ranger-1.2.0-admin /opt/ranger-admin</code></p>
<h3 id="Solr安装"><a href="#Solr安装" class="headerlink" title="Solr安装"></a>Solr安装</h3><p>修改配置文件 : <code>vim /opt/ranger-admin/contrib/solr_for_audit_setup/install.properties</code></p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">SOLR_INSTALL</span>=<span class="string">true</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># solr线上下载路径</span></span><br><span class="line"><span class="attr">SOLR_DOWNLOAD_URL</span>=<span class="string">http://archive.apache.org/dist/lucene/solr/8.4.0/solr-8.4.0.tgz</span></span><br></pre></td></tr></table></figure>

<p>执行初始化脚本(需在shell文件目录下执行) : <code>sh /opt/ranger-admin/contrib/solr_for_audit_setup/setup.sh</code></p>
<p>启动Solr : <code>sh /opt/solr/ranger_audit_server/scripts/start_solr.sh</code></p>
<h3 id="Admin安装"><a href="#Admin安装" class="headerlink" title="Admin安装"></a>Admin安装</h3><p>修改配置文件 : <code>vim /opt/ranger-admin/install.properties</code></p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">//Connector</span></span><br><span class="line"><span class="attr">SQL_CONNECTOR_JAR</span>=<span class="string">/opt/mysql-connector-java-5.1.46.jar</span></span><br><span class="line"></span><br><span class="line"><span class="attr">//DB</span></span><br><span class="line"><span class="attr">db_root_user</span>=<span class="string">root</span></span><br><span class="line"><span class="attr">db_root_password</span>=<span class="string">root</span></span><br><span class="line"><span class="attr">db_host</span>=<span class="string">192.168.101.32</span></span><br><span class="line"></span><br><span class="line"><span class="attr">//SSL</span></span><br><span class="line"><span class="attr">db_ssl_enabled</span>=<span class="string">true</span></span><br><span class="line"></span><br><span class="line"><span class="attr">//数据库初始化时候的库和用户</span></span><br><span class="line"><span class="attr">db_name</span>=<span class="string">ranger</span></span><br><span class="line"><span class="attr">db_user</span>=<span class="string">ranger</span></span><br><span class="line"><span class="attr">db_password</span>=<span class="string">ranger</span></span><br><span class="line"></span><br><span class="line"><span class="attr">//Solr</span></span><br><span class="line"><span class="attr">audit_store</span>=<span class="string">solr</span></span><br><span class="line"><span class="attr">audit_solr_urls</span>=<span class="string">http://192.168.101.32:6083/solr/ranger_audits</span></span><br></pre></td></tr></table></figure>

<p>执行初始化脚本(需在shell文件目录下执行) : <code>sh /opt/ranger-admin/setup.sh</code></p>
<blockquote>
<p>执行成功标志 : <code>Installation of Ranger PolicyManager Web Application is completed</code></p>
</blockquote>
<p>启动Admin : <code>ranger-admin start</code></p>
<p>访问地址 : <code>IP:6080</code></p>
<ul>
<li><p>Username : admin</p>
</li>
<li><p>Password : admin</p>
</li>
</ul>
<h2 id="Ranger-Usersync安装"><a href="#Ranger-Usersync安装" class="headerlink" title="Ranger Usersync安装"></a>Ranger Usersync安装</h2><h3 id="解压安装包-1"><a href="#解压安装包-1" class="headerlink" title="解压安装包"></a>解压安装包</h3><p><code>tar -zxvf ranger-1.2.0-SNAPSHOT-usersync.tar.gz</code></p>
<p><code>mv /opt/ranger-1.2.0-SNAPSHOT-usersync /opt/ranger-usersync</code></p>
<h3 id="Usersync安装"><a href="#Usersync安装" class="headerlink" title="Usersync安装"></a>Usersync安装</h3><p>修改配置文件 : <code>vim /opt/ranger-usersync/install.properties</code></p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Ranger Admin</span></span><br><span class="line"><span class="attr">POLICY_MGR_URL</span> = <span class="string">http://192.168.101.32:6080</span></span><br><span class="line"></span><br><span class="line"><span class="attr">SYNC_SOURCE</span> = <span class="string">unix</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 更新间隔</span></span><br><span class="line"><span class="attr">SYNC_INTERVAL</span> = <span class="string">1</span></span><br><span class="line"></span><br><span class="line"><span class="attr">unix_user</span>=<span class="string">usersync</span></span><br><span class="line"><span class="attr">unix_group</span>=<span class="string">usersync</span></span><br></pre></td></tr></table></figure>

<p>执行初始化脚本(需在shell文件目录下执行) : <code>sh /opt/ranger-usersync/setup.sh</code></p>
<p>启动Usersync : <code>ranger-usersync start</code></p>
<h2 id="Ranger-HDFS-Plugin安装"><a href="#Ranger-HDFS-Plugin安装" class="headerlink" title="Ranger HDFS Plugin安装"></a>Ranger HDFS Plugin安装</h2><h3 id="解压安装包-2"><a href="#解压安装包-2" class="headerlink" title="解压安装包"></a>解压安装包</h3><p><code>tar -zxvf ranger-1.2.0-hdfs-plugin.tar.gz</code></p>
<p><code>mv ranger-1.2.0-hdfs-plugin ranger-hdfs-plugin</code></p>
<h3 id="HDFS-Plugin安装"><a href="#HDFS-Plugin安装" class="headerlink" title="HDFS Plugin安装"></a>HDFS Plugin安装</h3><p>修改配置文件 : <code>vim /opt/ranger-hdfs-plugin/install.properties</code></p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Ranger Admin</span></span><br><span class="line"><span class="attr">POLICY_MGR_URL</span>=<span class="string">http://192.168.101.32:6080</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 策略管理的存储库名称</span></span><br><span class="line"><span class="attr">REPOSITORY_NAME</span>=<span class="string">hadoopdev</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># HDFS</span></span><br><span class="line"><span class="attr">COMPONENT_INSTALL_DIR_NAME</span>=<span class="string">/opt/hadoop</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 组件用户和组</span></span><br><span class="line"><span class="attr">CUSTOM_USER</span>=<span class="string">hdfs</span></span><br><span class="line"><span class="attr">CUSTOM_GROUP</span>=<span class="string">hadoop</span></span><br></pre></td></tr></table></figure>

<p>执行 : <code>/opt/ranger-hdfs-plugin/enable-hdfs-plugin.sh</code></p>
<blockquote>
<p>执行之后,HDFS配置目录下会增加<code>ranger-hdfs-audit.xml</code>,<code>ranger-hdfs-security.xml</code>,<code>ranger-policymgr-ssl.xml</code>三个配置文件</p>
</blockquote>
<blockquote>
<p><code>hdfs-site.xml</code>增加配置项</p>
</blockquote>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>dfs.permissions.enabled<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">value</span>&gt;</span>true<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>dfs.namenode.inode.attributes.provider.class<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">value</span>&gt;</span>org.apache.ranger.authorization.hadoop.RangerHdfsAuthorizer<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>LIB包下会增加<code>ranger-hdfs-plugin-shim-1.2.0.jar</code>,<code>ranger-plugin-classloader-1.2.0.jar</code>和文件夹<code>ranger-hdfs-plugin-impl</code></p>
</blockquote>
<p><strong>重启HDFS</strong></p>
<h3 id="Ranger-Admin-HDFS-HA-配置"><a href="#Ranger-Admin-HDFS-HA-配置" class="headerlink" title="Ranger Admin HDFS HA 配置"></a>Ranger Admin HDFS HA 配置</h3><p><img src="HDFSHA%E9%85%8D%E7%BD%AE.png" alt="HDFSHA配置"></p>
<ul>
<li>(dfs.nameservices:master)</li>
<li>(dfs.ha.namenodes.master:nn0,nn1)</li>
<li>(dfs.namenode.rpc-address.master.nn0:henghe-032:8020)</li>
<li>(dfs.namenode.rpc-address.master.nn1:henghe-033:8020)</li>
<li>(dfs.client.failover.proxy.provider.master:org.apache.hadoop.hdfs.server.namenode.ha.ConfiguredFailoverProxyProvider)</li>
</ul>
<h2 id="Ranger-Hive-Plugin安装"><a href="#Ranger-Hive-Plugin安装" class="headerlink" title="Ranger Hive Plugin安装"></a>Ranger Hive Plugin安装</h2><h3 id="解压安装包-3"><a href="#解压安装包-3" class="headerlink" title="解压安装包"></a>解压安装包</h3><p><code>tar -zxvf ranger-1.2.0-hive-plugin.tar.gz</code></p>
<p><code>mv ranger-1.2.0-hive-plugin ranger-hive-plugin</code></p>
<h3 id="Hive-Plugin安装"><a href="#Hive-Plugin安装" class="headerlink" title="Hive Plugin安装"></a>Hive Plugin安装</h3><p>修改配置文件 : <code>vim /opt/ranger-hive-plugin/install.properties</code></p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Ranger Admin</span></span><br><span class="line"><span class="attr">POLICY_MGR_URL</span>=<span class="string">http://192.168.101.32:6080</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 策略管理的存储库名称</span></span><br><span class="line"><span class="attr">REPOSITORY_NAME</span>=<span class="string">hivedev</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># HIVE</span></span><br><span class="line"><span class="attr">COMPONENT_INSTALL_DIR_NAME</span>=<span class="string">/opt/hive</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 组件用户和组</span></span><br><span class="line"><span class="attr">CUSTOM_USER</span>=<span class="string">hive</span></span><br><span class="line"><span class="attr">CUSTOM_GROUP</span>=<span class="string">hadoop</span></span><br></pre></td></tr></table></figure>

<p>执行 : <code>/opt/ranger-hive-plugin/enable-hive-plugin.sh</code></p>
<h2 id="Ranger-Yarn-Plugin安装"><a href="#Ranger-Yarn-Plugin安装" class="headerlink" title="Ranger Yarn Plugin安装"></a>Ranger Yarn Plugin安装</h2><h3 id="解压安装包-4"><a href="#解压安装包-4" class="headerlink" title="解压安装包"></a>解压安装包</h3><p><code>tar -zxvf ranger-1.2.0-yarn-plugin.tar.gz</code></p>
<p><code>mv ranger-1.2.0-yarn-plugin ranger-yarn-plugin</code></p>
<h3 id="Yarn-Plugin安装"><a href="#Yarn-Plugin安装" class="headerlink" title="Yarn Plugin安装"></a>Yarn Plugin安装</h3><p>修改配置文件 : <code>vim /opt/ranger-yarn-plugin/install.properties</code></p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Ranger Admin</span></span><br><span class="line"><span class="attr">POLICY_MGR_URL</span>=<span class="string">http://192.168.101.32:6080</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 策略管理的存储库名称</span></span><br><span class="line"><span class="attr">REPOSITORY_NAME</span>=<span class="string">yarndev</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Yarn</span></span><br><span class="line"><span class="attr">COMPONENT_INSTALL_DIR_NAME</span>=<span class="string">/opt/hadoop</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 组件用户和组</span></span><br><span class="line"><span class="attr">CUSTOM_USER</span>=<span class="string">yarn</span></span><br><span class="line"><span class="attr">CUSTOM_GROUP</span>=<span class="string">hadoop</span></span><br></pre></td></tr></table></figure>

<p>执行 : <code>/opt/ranger-yarn-plugin/enable-yarn-plugin.sh</code></p>
<h3 id="Yarn-Plugin安装注意"><a href="#Yarn-Plugin安装注意" class="headerlink" title="Yarn Plugin安装注意"></a>Yarn Plugin安装注意</h3><ul>
<li>Yarn Plugin只支持Yarn的默认调度器 : Capacity Scheduler</li>
</ul>
<h2 id="Ranger-Hbase-Plugin安装"><a href="#Ranger-Hbase-Plugin安装" class="headerlink" title="Ranger Hbase Plugin安装"></a>Ranger Hbase Plugin安装</h2><h3 id="解压安装包-5"><a href="#解压安装包-5" class="headerlink" title="解压安装包"></a>解压安装包</h3><p><code>tar -zxvf ranger-1.2.0-hbase-plugin.tar.gz</code></p>
<p><code>mv ranger-1.2.0-hbase-plugin ranger-hbase-plugin</code></p>
<h3 id="Hbase-Plugin安装"><a href="#Hbase-Plugin安装" class="headerlink" title="Hbase Plugin安装"></a>Hbase Plugin安装</h3><p>修改配置文件 : <code>vim /opt/ranger-hbase-plugin/install.properties</code></p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Ranger Admin</span></span><br><span class="line"><span class="attr">POLICY_MGR_URL</span>=<span class="string">http://192.168.101.32:6080</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 策略管理的存储库名称</span></span><br><span class="line"><span class="attr">REPOSITORY_NAME</span>=<span class="string">hbasedev</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Hbase</span></span><br><span class="line"><span class="attr">COMPONENT_INSTALL_DIR_NAME</span>=<span class="string">/opt/hbase</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 组件用户和组</span></span><br><span class="line"><span class="attr">CUSTOM_USER</span>=<span class="string">hbase</span></span><br><span class="line"><span class="attr">CUSTOM_GROUP</span>=<span class="string">hadoop</span></span><br></pre></td></tr></table></figure>

<p>执行 : <code>/opt/ranger-hbase-plugin/enable-yarn-plugin.sh</code></p>
<h3 id="Hbase-Plugin安装注意"><a href="#Hbase-Plugin安装注意" class="headerlink" title="Hbase Plugin安装注意"></a>Hbase Plugin安装注意</h3><ul>
<li>执行完启动脚本后,将Hbase文件夹中的添加的文件和JAR包更改所属</li>
</ul>
<h2 id="Ranger-Kafka-Plugin安装"><a href="#Ranger-Kafka-Plugin安装" class="headerlink" title="Ranger Kafka Plugin安装"></a>Ranger Kafka Plugin安装</h2><h3 id="解压安装包-6"><a href="#解压安装包-6" class="headerlink" title="解压安装包"></a>解压安装包</h3><p><code>tar -zxvf ranger-1.2.0-kafka-plugin.tar.gz</code></p>
<p><code>mv ranger-1.2.0-kafka-plugin ranger-kafka-plugin</code></p>
<h3 id="Kafka-Plugin安装"><a href="#Kafka-Plugin安装" class="headerlink" title="Kafka Plugin安装"></a>Kafka Plugin安装</h3>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/12/16/Elasticsearch-Java-High-Level-REST-Client-API/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/xiaoniao.jpg">
      <meta itemprop="name" content="SmallBird">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="SmallBird`s Blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2019/12/16/Elasticsearch-Java-High-Level-REST-Client-API/" class="post-title-link" itemprop="url">Elasticsearch Java High Level REST Client API</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2019-12-16 16:36:37" itemprop="dateCreated datePublished" datetime="2019-12-16T16:36:37+08:00">2019-12-16</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2020-03-11 17:53:00" itemprop="dateModified" datetime="2020-03-11T17:53:00+08:00">2020-03-11</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Elasticsearch/" itemprop="url" rel="index">
                    <span itemprop="name">Elasticsearch</span>
                  </a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="Java-High-Level-REST-Client"><a href="#Java-High-Level-REST-Client" class="headerlink" title="Java High Level REST Client"></a>Java High Level REST Client</h1><p>Java High Level REST Client在Java Low Level REST client之上工作。它的主要目标是公开API特定的方法，这些方法接受请求对象作为参数并返回响应对象，以便请求编组和响应反编组由客户机本身处理</p>
<p>可以同步或异步地调用每个API。同步方法返回一个响应对象，而异步方法(名称以async后缀结尾)则需要一个监听器参数，一旦接收到响应或错误，监听器参数(在低级客户机管理的线程池中)就会被通知</p>
<p>Java High Level REST Client依赖于Elasticsearch核心项目。它接受与TransportClient相同的请求参数，并返回相同的响应对象</p>
<h1 id="Getting-Started"><a href="#Getting-Started" class="headerlink" title="Getting Started"></a>Getting Started</h1><blockquote>
<p><a href="[https://artifacts.elastic.co/javadoc/org/elasticsearch/client/elasticsearch-rest-high-level-client/7.5.0/index.html](https://artifacts.elastic.co/javadoc/org/elasticsearch/client/elasticsearch-rest-high-level-client/7.5.0/index.html">JavaDoc</a></p>
</blockquote>
<h2 id="Maven-Repository"><a href="#Maven-Repository" class="headerlink" title="Maven Repository"></a>Maven Repository</h2><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;org.elasticsearch.client&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;elasticsearch-rest-high-level-client&lt;/artifactId&gt;</span><br><span class="line">    &lt;version&gt;7.5.0&lt;/version&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure>

<h2 id="Initialization"><a href="#Initialization" class="headerlink" title="Initialization"></a>Initialization</h2><p>RestHighLevelClient实例需要一个REST低级客户端生成器来构建</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String ELASTICSEARCH_IP1 = <span class="string">"192.168.101.32"</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String ELASTICSEARCH_IP2 = <span class="string">"192.168.101.33"</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String ELASTICSEARCH_IP3 = <span class="string">"192.168.101.34"</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> ELASTICSEARCH_PORT = <span class="number">9200</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String ELASTICSEARCH_SCHEME = <span class="string">"HTTP"</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> RestHighLevelClient <span class="title">createClient</span> <span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        RestHighLevelClient restHighLevelClient = <span class="keyword">new</span> RestHighLevelClient(</span><br><span class="line">                RestClient.builder(</span><br><span class="line">                        <span class="keyword">new</span> HttpHost(ELASTICSEARCH_IP1, ELASTICSEARCH_PORT, ELASTICSEARCH_SCHEME),</span><br><span class="line">                        <span class="keyword">new</span> HttpHost(ELASTICSEARCH_IP2, ELASTICSEARCH_PORT, ELASTICSEARCH_SCHEME),</span><br><span class="line">                        <span class="keyword">new</span> HttpHost(ELASTICSEARCH_IP3, ELASTICSEARCH_PORT, ELASTICSEARCH_SCHEME)</span><br><span class="line">                )</span><br><span class="line">        );</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> restHighLevelClient;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>关闭连接</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">closeClient</span> <span class="params">(RestHighLevelClient client)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line">        client.close();</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="Document-API"><a href="#Document-API" class="headerlink" title="Document API"></a>Document API</h1><h2 id="Single-document-API"><a href="#Single-document-API" class="headerlink" title="Single document API"></a>Single document API</h2><p>单文档API</p>
<h3 id="Index-API"><a href="#Index-API" class="headerlink" title="Index API"></a>Index API</h3><p><strong>Index Request</strong></p>
<p>三种数据源加载方式</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//第一种数据源方式</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">indexApiSource1</span> <span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        IndexRequest request = <span class="keyword">new</span> IndexRequest(<span class="string">"posts"</span>);</span><br><span class="line">        request.id(<span class="string">"1"</span>);</span><br><span class="line">        String jsonString = <span class="string">"&#123;"</span> +</span><br><span class="line">                <span class="string">"\"user\":\"kimchy\","</span> +</span><br><span class="line">                <span class="string">"\"postDate\":\"2013-01-30\","</span> +</span><br><span class="line">                <span class="string">"\"message\":\"trying out Elasticsearch\""</span> +</span><br><span class="line">                <span class="string">"&#125;"</span>;</span><br><span class="line">        request.source(jsonString, XContentType.JSON);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// 第二种数据源方式</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">indexApiSource2</span> <span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        Map&lt;String, Object&gt; jsonMap = <span class="keyword">new</span> HashMap&lt;String, Object&gt;();</span><br><span class="line">        jsonMap.put(<span class="string">"user"</span>, <span class="string">"kimchy"</span>);</span><br><span class="line">        jsonMap.put(<span class="string">"postDate"</span>, <span class="keyword">new</span> Date());</span><br><span class="line">        jsonMap.put(<span class="string">"message"</span>, <span class="string">"trying out Elasticsearch"</span>);</span><br><span class="line"></span><br><span class="line">        IndexRequest request = <span class="keyword">new</span> IndexRequest(<span class="string">"posts"</span>).id(<span class="string">"1"</span>).source(jsonMap);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//第三种数据源方式</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">indexApiSource3</span> <span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        IndexRequest request  = <span class="keyword">new</span> IndexRequest(<span class="string">"posts"</span>).id(<span class="string">"1"</span>).source(</span><br><span class="line">                <span class="string">"user"</span>, <span class="string">"kimchy"</span>,</span><br><span class="line">                <span class="string">"postDate"</span>, <span class="keyword">new</span> Date(),</span><br><span class="line">                <span class="string">"message"</span>, <span class="string">"trying out Elasticsearch"</span></span><br><span class="line">        );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/12/05/Elasticsearch-RESTful-Api/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/xiaoniao.jpg">
      <meta itemprop="name" content="SmallBird">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="SmallBird`s Blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2019/12/05/Elasticsearch-RESTful-Api/" class="post-title-link" itemprop="url">Elasticsearch RESTful API使用</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2019-12-05 16:46:16" itemprop="dateCreated datePublished" datetime="2019-12-05T16:46:16+08:00">2019-12-05</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2020-03-11 17:53:00" itemprop="dateModified" datetime="2020-03-11T17:53:00+08:00">2020-03-11</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Elasticsearch/" itemprop="url" rel="index">
                    <span itemprop="name">Elasticsearch</span>
                  </a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="RESTful-API"><a href="#RESTful-API" class="headerlink" title="RESTful API"></a>RESTful API</h1><h2 id="Rest"><a href="#Rest" class="headerlink" title="Rest"></a>Rest</h2><ul>
<li>Representational State Transfer : 表述性状态转变</li>
<li>它首次出现在2000年Roy Fielding的博士论文中,Roy Fielding是HTTP规范的主要编写者之一.他在论文中提到：”我这篇文章的写作目的，就是想在符合架构原理的前提下,理解和评估以网络为基础的应用软件的架构设计,得到一个功能强、性能好、适宜通信的架构</li>
<li>REST指的是一组架构约束条件和原则.如果一个架构符合REST的约束条件和原则,我们就称它为RESTful架构</li>
</ul>
<p><img src="Restful.png" alt="Restful.png"></p>
<h2 id="RESTful"><a href="#RESTful" class="headerlink" title="RESTful"></a>RESTful</h2><ul>
<li>RESTful是一种常见的REST应用,是遵循REST风格的web服务,REST式的web服务是一种ROA(面向资源的架构)</li>
<li>它使用典型的HTTP方法,诸如GET,POST.DELETE,PUT来实现资源的获取,添加,修改,删除等操作.即通过HTTP动词来实现资源的状态扭转</li>
</ul>
<p><img src="restapi.png" alt="restapi.png"></p>
<h2 id="HTTP响应状态码"><a href="#HTTP响应状态码" class="headerlink" title="HTTP响应状态码"></a>HTTP响应状态码</h2><p>根据http响应码,判断请求状态,进而做出提醒</p>
<p><img src="http.png" alt="http.png"></p>
<h1 id="Mapping详解"><a href="#Mapping详解" class="headerlink" title="Mapping详解"></a>Mapping详解</h1><p>Mapping是ES中的一个很重要的内容,它类似于传统关系型数据库中的Table的Schema,用于定义一个索引(Index)的某个类型(Type)的数据的结构</p>
<p>在ES中,我们无需手动创建type和mapping.在默认配置下,ES可以根据插入的数据自动地创建type及其mapping,也可以通过配置文件关闭ES的自动创建mapping功能</p>
<p><strong>mapping中主要包括字段名,字段数据类型和字段索引类型这三个方面的定义</strong></p>
<p><code>字段名</code>: 与传统数据库字段名作用一样,就是给字段起个唯一的名字,好让系统和用户能识别</p>
<p><code>字段数据类型</code>:  定义该字段保存的数据的类型,不符合数据类型定义的数据不能保存到ES中</p>
<p><em>ES所支持的数据类型</em></p>
<table>
<thead>
<tr>
<th>数据类型大类</th>
<th>数据类型小类</th>
</tr>
</thead>
<tbody><tr>
<td>String</td>
<td>string,text,keyword</td>
</tr>
<tr>
<td>Whole number</td>
<td>byte,short,integer,long</td>
</tr>
<tr>
<td>Floating point</td>
<td>float,double</td>
</tr>
<tr>
<td>Boolean</td>
<td>boolean</td>
</tr>
<tr>
<td>Date</td>
<td>date</td>
</tr>
</tbody></table>
<ul>
<li>text：该类型被用来索引长文本，在创建索引前会将这些文本进行分词，转化为词的组合，建立索引；允许es来检索这些词，text类型不能用来排序和聚合</li>
<li>keyword：该类型不需要进行分词，可以被用来检索过滤、排序和聚合，keyword类型自读那只能用本身来进行检索（不可用text分词后的模糊检索）</li>
</ul>
<p><code>字段索引类型</code>: 索引是ES中的核心,ES之所以能够实现实时搜索,完全归功于Lucene这个优秀的Java开源索引.在传统数据库中,如果字段上建立索引,我们仍然能够以它作为查询条件进行查询,只不过查询速度慢点.而在ES中,字段如果不建立索引,则就不能以这个字段作为查询条件来搜索</p>
<p><em>mapping中string类型字段可以配置的索引类型</em></p>
<table>
<thead>
<tr>
<th>索引类型</th>
<th>解释</th>
</tr>
</thead>
<tbody><tr>
<td>analyzed</td>
<td>首先分析这个字符串,然后再建立索引.换言之,以全文形式索引此字段</td>
</tr>
<tr>
<td>not_analyzed</td>
<td>索引这个字段,使之可以被搜索,但是索引内容和指定值一样.不分析此字段</td>
</tr>
<tr>
<td>no</td>
<td>不索引这个字段.这个字段不能被搜索到</td>
</tr>
</tbody></table>
<p>如果索引类型设置为analyzed,在表示ES会先对这个字段进行分析(一般来说,就是自然语言中的分词)</p>
<h1 id="Elasticsearch-RESTful-API使用"><a href="#Elasticsearch-RESTful-API使用" class="headerlink" title="Elasticsearch RESTful API使用"></a>Elasticsearch RESTful API使用</h1><h2 id="集群信息API"><a href="#集群信息API" class="headerlink" title="集群信息API"></a>集群信息API</h2><h3 id="查看集群健康信息"><a href="#查看集群健康信息" class="headerlink" title="查看集群健康信息"></a>查看集群健康信息</h3><p><code>curl -XGET &quot;localhost:9200/_cat/health?v&quot;</code></p>
<p><em>返回结果:</em></p>
<table>
<thead>
<tr>
<th>epoch</th>
<th>timestamp</th>
<th>cluster</th>
<th>status</th>
<th>node.total</th>
<th>node.data</th>
<th>shards</th>
<th>pri</th>
<th>relo</th>
<th>init</th>
<th>unassign</th>
<th>pending_tasks</th>
<th>max_task_wait_time</th>
<th>active_shards_percent</th>
</tr>
</thead>
<tbody><tr>
<td>1575537821</td>
<td>09:23:41</td>
<td>HengheElasticsearch</td>
<td>green</td>
<td>2</td>
<td>2</td>
<td>10</td>
<td>5</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>-</td>
<td>100.0%</td>
</tr>
</tbody></table>
<p><em>结果字段意义:</em></p>
<ul>
<li>cluster: 集群名.elasticsearch.yml配置文件中配置的cluster.name值</li>
<li>status: 集群状态.集群共有green(一切正常),yellow(所有数据可用,但是某些复制没有被分配)或red(某些数据不可用)中的三种状态</li>
<li>node.total: 集群中的节点数</li>
<li>node.data: 集群中的数据节点数</li>
<li>shards: 集群中总的分片数量</li>
<li>pri: 主分片数量,英文全称为private</li>
<li>relo: 复制分片总数</li>
<li>unassign: 未指定的分片数量</li>
</ul>
<h3 id="查看集群中的节点信息"><a href="#查看集群中的节点信息" class="headerlink" title="查看集群中的节点信息"></a>查看集群中的节点信息</h3><p><code>curl -XGET &quot;localhost:9200/_cat/nodes?v&quot;</code></p>
<p><em>返回结果:</em></p>
<table>
<thead>
<tr>
<th>ip</th>
<th>heap.percent</th>
<th>ram.percent</th>
<th>cpu</th>
<th>load_1m</th>
<th>load_5m</th>
<th>load_15m</th>
<th>node.role</th>
<th>master</th>
<th>name</th>
</tr>
</thead>
<tbody><tr>
<td>192.168.101.33</td>
<td>48</td>
<td>69</td>
<td>4</td>
<td>0.39</td>
<td>0.44</td>
<td>0.46</td>
<td>mdi</td>
<td>*</td>
<td>henghe-033</td>
</tr>
<tr>
<td>192.168.101.34</td>
<td>46</td>
<td>34</td>
<td>1</td>
<td>0.23</td>
<td>0.25</td>
<td>0.22</td>
<td>mdi</td>
<td>-</td>
<td>henghe-034</td>
</tr>
</tbody></table>
<h3 id="查看集群中的索引信息"><a href="#查看集群中的索引信息" class="headerlink" title="查看集群中的索引信息"></a>查看集群中的索引信息</h3><p><code>curl -XGET &quot;localhost:9200/_cat/indices?v&quot;</code></p>
<p><em>返回结果:</em></p>
<table>
<thead>
<tr>
<th>health</th>
<th>status</th>
<th>index</th>
<th>uuid</th>
<th>pri</th>
<th>rep</th>
<th>docs.count</th>
<th>docs.deleted</th>
<th>store.size</th>
<th>pri.store.size</th>
</tr>
</thead>
<tbody><tr>
<td>green</td>
<td>open</td>
<td>index</td>
<td>VULTFuhATu-2CJtghd51lQ</td>
<td>5</td>
<td>1</td>
<td>0</td>
<td>0</td>
<td>2.5kb</td>
<td>1.2kb</td>
</tr>
</tbody></table>
<h2 id="Index相关API"><a href="#Index相关API" class="headerlink" title="Index相关API"></a>Index相关API</h2><h3 id="创建新的索引"><a href="#创建新的索引" class="headerlink" title="创建新的索引"></a>创建新的索引</h3><p><code>curl -XPUT &quot;localhost:9200/index_one&quot;</code></p>
<p><em>返回信息:</em> {“acknowledged”:true,”shards_acknowledged”:true,”index”:”index_one”}</p>
<p>上面的操作使用默认的配置信息创建一个索引。大多数情况下，我们想在索引创建的时候就将我们所需的mapping和其他配置确定好。下面的操作就可以在创建索引的同时，创建settings和mapping</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">curl -XPUT &quot;localhost:9200/index_test&quot; -d &apos;     # 注意这里的&apos;号</span><br><span class="line">&#123;</span><br><span class="line">  &quot;settings&quot;: &#123;</span><br><span class="line">    &quot;index&quot;: &#123;</span><br><span class="line">      &quot;number_of_replicas&quot;: &quot;1&quot;, # 设置复制数</span><br><span class="line">      &quot;number_of_shards&quot;: &quot;5&quot; # 设置主分片数</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;mappings&quot;: &#123; # 创建mapping</span><br><span class="line">    &quot;test_type&quot;: &#123; # 在index中创建一个新的type(相当于table)</span><br><span class="line">      &quot;properties&quot;: &#123;</span><br><span class="line">        &quot;name&quot;: &#123; # 创建一个字段（string类型数据，使用普通索引）</span><br><span class="line">          &quot;type&quot;: &quot;string&quot;,</span><br><span class="line">          &quot;index&quot;: &quot;not_analyzed&quot;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;age&quot;: &#123;</span><br><span class="line">          &quot;type&quot;: &quot;integer&quot;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;&apos;</span><br></pre></td></tr></table></figure>

<h3 id="删除一个索引"><a href="#删除一个索引" class="headerlink" title="删除一个索引"></a>删除一个索引</h3><p><code>curl -XDELETE &quot;localhost:9200/index_test&quot;</code></p>
<p><em>返回信息:</em> {“acknowledged”:true}</p>
<h2 id="Docunent相关API"><a href="#Docunent相关API" class="headerlink" title="Docunent相关API"></a>Docunent相关API</h2><h3 id="新增一个文档"><a href="#新增一个文档" class="headerlink" title="新增一个文档"></a>新增一个文档</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">curl -H &quot;Content-Type: application/json&quot; -XPUT &apos;localhost:9200/index_test/test_type/1?pretty&apos; -d &apos;</span><br><span class="line">&#123;</span><br><span class="line">    &quot;name&quot;: &quot;zhangsan&quot;,</span><br><span class="line">    &quot;age&quot; : &quot;12&quot;</span><br><span class="line">&#125;&apos;</span><br></pre></td></tr></table></figure>

<h3 id="更新一个文档"><a href="#更新一个文档" class="headerlink" title="更新一个文档"></a>更新一个文档</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">curl -H &quot;Content-Type: application/json&quot; -XPOST &apos;localhost:9200/index_test/test_type/1?pretty&apos; -d &apos; # 这里的1必须是索引中已经存在id，否则就会变成新增文档操作</span><br><span class="line">&#123;</span><br><span class="line">    &quot;name&quot;: &quot;lisi&quot;,</span><br><span class="line">    &quot;age&quot; : &quot;12&quot;</span><br><span class="line">&#125;&apos;</span><br></pre></td></tr></table></figure>

<h3 id="删除一个文档"><a href="#删除一个文档" class="headerlink" title="删除一个文档"></a>删除一个文档</h3><p><code>curl -H &quot;Content-Type: application/json&quot; -XDELETE &#39;localhost:9200/index_test/test_type/1?pretty&#39;</code> # 这里的1必须是索引中已经存在id</p>
<h3 id="查询单个文档"><a href="#查询单个文档" class="headerlink" title="查询单个文档"></a>查询单个文档</h3><p><code>curl -H &quot;Content-Type: application/json&quot; -XGET &#39;localhost:9200/index_test/test_type/1?pretty&#39;</code></p>
<h2 id="基本Query查询"><a href="#基本Query查询" class="headerlink" title="基本Query查询"></a>基本Query查询</h2><p>Elasticsearch Query查询</p>
<h3 id="数据准备及简单查询"><a href="#数据准备及简单查询" class="headerlink" title="数据准备及简单查询"></a>数据准备及简单查询</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"># 创建索引,指定Mapping</span><br><span class="line">PUT /estest</span><br><span class="line">&#123;</span><br><span class="line">  &quot;settings&quot;: &#123;</span><br><span class="line">    &quot;number_of_shards&quot;: 3,</span><br><span class="line">    &quot;number_of_replicas&quot;: 1</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;mappings&quot;: &#123;</span><br><span class="line">    &quot;test&quot; : &#123;</span><br><span class="line">      &quot;properties&quot; : &#123;</span><br><span class="line">        &quot;name&quot; : &#123;&quot;type&quot; : &quot;text&quot;&#125;,</span><br><span class="line">        &quot;address&quot; : &#123;&quot;type&quot; : &quot;text&quot;&#125;,</span><br><span class="line">        &quot;age&quot; : &#123;&quot;type&quot; : &quot;integer&quot;&#125;,</span><br><span class="line">        &quot;interests&quot; : &#123;&quot;type&quot; : &quot;text&quot;&#125;,</span><br><span class="line">        &quot;birthday&quot; : &#123;&quot;type&quot; : &quot;date&quot;&#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># 添加文档</span><br><span class="line">PUT /estest/test/1</span><br><span class="line">&#123;</span><br><span class="line">  &quot;name&quot; : &quot;xiaohua&quot;,</span><br><span class="line">  &quot;address&quot; : &quot;beijing&quot;,</span><br><span class="line">  &quot;age&quot; : 52,</span><br><span class="line">  &quot;interests&quot; : &quot;duanlian&quot;,</span><br><span class="line">  &quot;birthday&quot; : &quot;1970-12-12&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">PUT /estest/test/2</span><br><span class="line">&#123;</span><br><span class="line">  &quot;name&quot; : &quot;xiaoming&quot;,</span><br><span class="line">  &quot;address&quot; : &quot;beijing&quot;,</span><br><span class="line">  &quot;age&quot; : 66,</span><br><span class="line">  &quot;birthday&quot; : &quot;1976-12-12&quot;,</span><br><span class="line">  &quot;interests&quot; : &quot;duanlian&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">PUT /estest/test/3</span><br><span class="line">&#123;</span><br><span class="line">  &quot;name&quot; : &quot;xiaotian&quot;,</span><br><span class="line">  &quot;address&quot; : &quot;jilin&quot;,</span><br><span class="line">  &quot;age&quot; : 69,</span><br><span class="line">  &quot;interests&quot; : &quot;chifan&quot;,</span><br><span class="line">  &quot;birthday&quot; : &quot;1970-12-26&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># 简单查询</span><br><span class="line">GET /estest/test/_search?q=name:xiaotian</span><br><span class="line">GET /estest/test/_search?q=interests:duanlian&amp;sort=age:desc</span><br><span class="line"></span><br><span class="line"># 返回结果</span><br><span class="line">&#123;</span><br><span class="line">  &quot;took&quot; : 5, # 当前搜索所用的时间</span><br><span class="line">  &quot;timed_out&quot; : false, # 是否超时</span><br><span class="line">  &quot;_shards&quot; : &#123; # 分片信息</span><br><span class="line">    &quot;total&quot; : 3, # 总分片数</span><br><span class="line">    &quot;successful&quot; : 3, # 请求成功的分片</span><br><span class="line">    &quot;skipped&quot; : 0, # 请求跳过的分片</span><br><span class="line">    &quot;failed&quot; : 0 # 请求失败的分片</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;hits&quot; : &#123;</span><br><span class="line">    &quot;total&quot; : 1, # 查询出的文档数</span><br><span class="line">    &quot;max_score&quot; : 0.6931472, # 相关度分数(即查出的文档和搜索条件的匹配度,完全匹配为最大值1)</span><br><span class="line">    &quot;hits&quot; : [</span><br><span class="line">      &#123;</span><br><span class="line">        &quot;_index&quot; : &quot;estest&quot;,</span><br><span class="line">        &quot;_type&quot; : &quot;test&quot;,</span><br><span class="line">        &quot;_id&quot; : &quot;3&quot;,</span><br><span class="line">        &quot;_score&quot; : 0.6931472,</span><br><span class="line">        &quot;_source&quot; : &#123;</span><br><span class="line">          &quot;name&quot; : &quot;xiaotian&quot;,</span><br><span class="line">          &quot;address&quot; : &quot;jilin&quot;,</span><br><span class="line">          &quot;age&quot; : 69,</span><br><span class="line">          &quot;interests&quot; : &quot;chifan&quot;,</span><br><span class="line">          &quot;birthday&quot; : &quot;1970-12-26&quot;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="term查询和terms查询"><a href="#term查询和terms查询" class="headerlink" title="term查询和terms查询"></a>term查询和terms查询</h3><p>term query回去倒排索引中寻找确切的term(即精准查询),它并不知道分词器的存在.这种查询适合keyword,numeric,date</p>
<p><code>term:</code> 查询某个字段里含有某个关键词的文档</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">GET /estest/test/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123; &quot;term&quot;: &#123;</span><br><span class="line">    &quot;interests&quot;: &#123;</span><br><span class="line">      &quot;value&quot;: &quot;duanlian&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>terms:</code> 查询某个字段里含有多个关键字的文档</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">GET /estest/test/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123; &quot;terms&quot;: &#123;</span><br><span class="line">    &quot;interests&quot;: [</span><br><span class="line">      &quot;duanlian&quot;,</span><br><span class="line">      &quot;chifan&quot;</span><br><span class="line">    ]</span><br><span class="line">  &#125;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="控制查询返回的数量"><a href="#控制查询返回的数量" class="headerlink" title="控制查询返回的数量"></a>控制查询返回的数量</h3><p><code>from:</code> 从哪一个文档开始<br><code>size:</code> 需要的个数</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">GET /estest/test/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;from&quot;: 0,</span><br><span class="line">  &quot;size&quot;: 2,</span><br><span class="line">  &quot;query&quot;: &#123; &quot;terms&quot;: &#123;</span><br><span class="line">    &quot;interests&quot;: [</span><br><span class="line">      &quot;duanlian&quot;,</span><br><span class="line">      &quot;chifan&quot;</span><br><span class="line">    ]</span><br><span class="line">  &#125;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="返回版本号"><a href="#返回版本号" class="headerlink" title="返回版本号"></a>返回版本号</h3><p><code>version:</code> 当设置version为true时,查询的文档中将返回版本信息,默认情况是false</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">GET /estest/test/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;version&quot;: true, </span><br><span class="line">  &quot;query&quot;: &#123; &quot;terms&quot;: &#123;</span><br><span class="line">    &quot;interests&quot;: [</span><br><span class="line">      &quot;duanlian&quot;,</span><br><span class="line">      &quot;chifan&quot;</span><br><span class="line">    ]</span><br><span class="line">  &#125;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="match查询"><a href="#match查询" class="headerlink" title="match查询"></a>match查询</h3><p><code>match:</code> query知道分词器的存在，会对filed进行分词操作，然后在查询</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">GET /estest/test/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123; &quot;match&quot;: &#123;</span><br><span class="line">    &quot;name&quot;: &quot;xiaohua&quot;</span><br><span class="line">  &#125;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>match_all：</code>查询所有文档</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">GET /estest/test/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot; : &#123;</span><br><span class="line">    &quot;match_all&quot; : &#123;&#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>multi_match：</code>可以指定多个字段</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">GET /estest/test/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123; </span><br><span class="line">    &quot;multi_match&quot;: &#123;</span><br><span class="line">      &quot;query&quot;: &quot;beijing&quot;,</span><br><span class="line">      &quot;fields&quot;: [&quot;address&quot;,&quot;interests&quot;]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>match_phrase：</code>短语匹配查询</p>
<p>Elasticsearch引擎首先分析（analyze）查询字符串，从分析后的文本中构建短语查询，这意味着必须匹配短语中的所有分词，并且保证各个分词的相对位置不变</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">GET /estest/test/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123; &quot;match_phrase&quot;: &#123;</span><br><span class="line">    &quot;interests&quot;: &quot;duanlian, chifan&quot;</span><br><span class="line">  &#125;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="指定返回字段"><a href="#指定返回字段" class="headerlink" title="指定返回字段"></a>指定返回字段</h3><p><code>_source：</code>可在_source中设置想返回的字段</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">GET /estest/test/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;_source&quot;: [&quot;address&quot;,&quot;name&quot;],</span><br><span class="line">  &quot;query&quot;: &#123; &quot;match&quot;: &#123;</span><br><span class="line">    &quot;interests&quot;: &quot;duanlian&quot;</span><br><span class="line">  &#125;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="控制加载的字段"><a href="#控制加载的字段" class="headerlink" title="控制加载的字段"></a>控制加载的字段</h3><p><code>includes：</code>包含某些字段，可以使用通配符进行查询<br><code>excludes：</code>排除某些字段，可以使用通配符进行查询</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">GET /estest/test/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;_source&quot;: &#123;</span><br><span class="line">    &quot;includes&quot;: [&quot;name&quot;,&quot;address&quot;]</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;query&quot;: &#123; &quot;match_all&quot;: &#123;&#125;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">GET /estest/test/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;_source&quot;: &#123;</span><br><span class="line">    &quot;excludes&quot;: [&quot;age&quot;,&quot;birthday&quot;]</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;query&quot;: &#123; &quot;match_all&quot;: &#123;&#125;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="排序"><a href="#排序" class="headerlink" title="排序"></a>排序</h3><p>使用<code>sort</code>实现排序,desc降序,asc升序</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">GET /estest/test/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;sort&quot;: [</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;age&quot;: &#123;</span><br><span class="line">        &quot;order&quot;: &quot;desc&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  ],</span><br><span class="line">  &quot;query&quot;: &#123; &quot;match_all&quot;: &#123;&#125;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="前缀匹配查询"><a href="#前缀匹配查询" class="headerlink" title="前缀匹配查询"></a>前缀匹配查询</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">GET /estest/test/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123; &quot;match_phrase_prefix&quot;: &#123;</span><br><span class="line">    &quot;name&quot;: &quot;xiao&quot;</span><br><span class="line">  &#125;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="范围查询"><a href="#范围查询" class="headerlink" title="范围查询"></a>范围查询</h3><p><code>range:</code> 实现范围查询<br>参数: from、to、include_lower、include_upper、boost</p>
<ul>
<li>include_lower：是否包含范围的左边界，默认是true</li>
<li>include_upper：是否包含范围的右边界，默认是true</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">GET /estest/test/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123; &quot;range&quot;: &#123;</span><br><span class="line">    &quot;birthday&quot;: &#123;</span><br><span class="line">      &quot;from&quot;: &quot;1970-12-10&quot;,</span><br><span class="line">      &quot;to&quot;: &quot;1970-12-30&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">GET /estest/test/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123; &quot;range&quot;: &#123;</span><br><span class="line">    &quot;birthday&quot;: &#123;</span><br><span class="line">      &quot;gte&quot;: &quot;1970-12-10&quot;,</span><br><span class="line">      &quot;lte&quot;: &quot;1970-12-30&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">GET /estest/test/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123; &quot;range&quot;: &#123;</span><br><span class="line">    &quot;age&quot;: &#123;</span><br><span class="line">      &quot;from&quot;: 52,</span><br><span class="line">      &quot;to&quot;: 60,</span><br><span class="line">      &quot;include_lower&quot;: true,</span><br><span class="line">      &quot;include_upper&quot;: false</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="wildcard查询"><a href="#wildcard查询" class="headerlink" title="wildcard查询"></a>wildcard查询</h3><p>允许使用通配符 * 和 ? 来进行查询</p>
<ul>
<li>*：代表0个或者多个字符</li>
<li>?：代表任意一个字符</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">GET /estest/test/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123; &quot;wildcard&quot;: &#123;</span><br><span class="line">    &quot;name&quot;: &#123;</span><br><span class="line">      &quot;value&quot;: &quot;xiao*&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">GET /estest/test/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123; &quot;wildcard&quot;: &#123;</span><br><span class="line">    &quot;name&quot;: &#123;</span><br><span class="line">      &quot;value&quot;: &quot;xi?ohua&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="fuzzy实现模糊查询"><a href="#fuzzy实现模糊查询" class="headerlink" title="fuzzy实现模糊查询"></a>fuzzy实现模糊查询</h3><p><code>value：</code>查询的关键字</p>
<p><code>boost：</code>查询的权值，默认值是1.0</p>
<p><code>min_similarity：</code>设置匹配的最小相似度，默认值为0.5，对于字符串，取值为0-1（包含0和1）；对于数值，取值可能大于1；对于日期类型取值为1d，1m等，1d就代表1天</p>
<p><code>prefix_length：</code>指明区分词项的共同前缀长度，默认是0</p>
<p><code>max_expansions：</code>查询中的词项可以扩展的数目，默认可以无限大</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">GET /estest/test/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123; &quot;fuzzy&quot;: &#123;</span><br><span class="line">    &quot;interests&quot;: &quot;duanli&quot;</span><br><span class="line">  &#125;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="高亮搜索结果"><a href="#高亮搜索结果" class="headerlink" title="高亮搜索结果"></a>高亮搜索结果</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">GET /estest/test/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123; &quot;match&quot;: &#123;</span><br><span class="line">    &quot;interests&quot;: &quot;duanlian&quot;</span><br><span class="line">  &#125;&#125;,</span><br><span class="line">  &quot;highlight&quot;: &#123; &quot;fields&quot;: &#123;</span><br><span class="line">    &quot;interests&quot;: &#123;&#125;</span><br><span class="line">  &#125;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="查询结果分析"><a href="#查询结果分析" class="headerlink" title="查询结果分析"></a>查询结果分析</h3><p><code>took：</code>查询耗费的时间，单位是毫秒</p>
<p><code>_shard：</code>共请求了多少个shard</p>
<p><code>total：</code>查询出的文档总个数</p>
<p><code>max_score：</code>本次查询中，相关度分数的最大值，文档和此次查询的匹配度越高，_score的值越大，排位越考前</p>
<p><code>hits：</code>默认查询前10个文档</p>
<p><code>time_out：</code> 查询超时时间，设置超时时间将返回已经查询出来的数据</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;took&quot; : 8,</span><br><span class="line">  &quot;timed_out&quot; : false,</span><br><span class="line">  &quot;_shards&quot; : &#123;</span><br><span class="line">    &quot;total&quot; : 3,</span><br><span class="line">    &quot;successful&quot; : 3,</span><br><span class="line">    &quot;skipped&quot; : 0,</span><br><span class="line">    &quot;failed&quot; : 0</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;hits&quot; : &#123;</span><br><span class="line">    &quot;total&quot; : 2,</span><br><span class="line">    &quot;max_score&quot; : 0.6931472,</span><br><span class="line">    &quot;hits&quot; : [</span><br></pre></td></tr></table></figure>

<h3 id="多index、多type查询模式"><a href="#多index、多type查询模式" class="headerlink" title="多index、多type查询模式"></a>多index、多type查询模式</h3><p>指定estest、estest1索引下的所有文档: <code>GET /estest,estest1/_search</code></p>
<p><em>号为通配符，查询结尾是t和1的索引下的所有文档: `GET /</em>t,*1/_search`</p>
<p>_all表示集群下的所有索引: <code>GET /_all/_search</code></p>
<h2 id="Multi-Get批量获取"><a href="#Multi-Get批量获取" class="headerlink" title="Multi Get批量获取"></a>Multi Get批量获取</h2><p>Multi Get API可以通过索引名,类型名,文档ID,字段名 一次得到一个文档集合,文档可以来自同一个索引库,也可以来自不同的索引库</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">GET _mget</span><br><span class="line">&#123;</span><br><span class="line">  &quot;docs&quot; : [</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;_index&quot; : &quot;cluster2-hdfs-6.6.1-2019.12.11&quot;,</span><br><span class="line">      &quot;_type&quot; : &quot;doc&quot;,</span><br><span class="line">      &quot;_id&quot; : &quot;0Y2d8m4BxKCpIylf-0lj&quot;,</span><br><span class="line">      &quot;_source&quot; : &quot;offset&quot;</span><br><span class="line">    &#125;,&#123;</span><br><span class="line">      &quot;_index&quot; : &quot;cluster2-hdfs-6.6.1-2019.12.11&quot;,</span><br><span class="line">      &quot;_type&quot; : &quot;doc&quot;,</span><br><span class="line">      &quot;_id&quot; : &quot;0o2d8m4BxKCpIylf-0lj&quot;,</span><br><span class="line">      &quot;_source&quot; : &quot;clustername&quot;</span><br><span class="line">    &#125;,&#123;</span><br><span class="line">      &quot;_index&quot; : &quot;cluster2-hdfs-6.6.1-2019.12.11&quot;,</span><br><span class="line">      &quot;_type&quot; : &quot;doc&quot;,</span><br><span class="line">      &quot;_id&quot; : &quot;1I2d8m4BxKCpIylf-0lj&quot;,</span><br><span class="line">      &quot;_source&quot; : &quot;logfile&quot;</span><br><span class="line">    &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">GET /cluster2-hdfs-6.6.1-2019.12.11/doc/_mget</span><br><span class="line">&#123;</span><br><span class="line">  &quot;docs&quot; : [</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;_id&quot; : &quot;0Y2d8m4BxKCpIylf-0lj&quot;</span><br><span class="line">    &#125;,&#123;</span><br><span class="line">      &quot;_id&quot; : &quot;0o2d8m4BxKCpIylf-0lj&quot;</span><br><span class="line">    &#125;]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">//简写</span><br><span class="line">GET /cluster2-hdfs-6.6.1-2019.12.11/doc/_mget</span><br><span class="line">&#123;</span><br><span class="line">  &quot;ids&quot; : [&quot;0Y2d8m4BxKCpIylf-0lj&quot;,&quot;0o2d8m4BxKCpIylf-0lj&quot;]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Bulk批量操作"><a href="#Bulk批量操作" class="headerlink" title="Bulk批量操作"></a>Bulk批量操作</h2><p><strong>bulk格式:</strong><br>{action:{metadata}}\n<br>{requestbody}\n</p>
<p><code>action(行为):</code> 包含<code>create(文档不存在时创建)</code>,<code>update(更新文档)</code>,<code>index(创建新文档或替换已用文档)</code>,<code>delete(删除一个文档)</code></p>
<ul>
<li><code>create</code>和<code>index</code>的区别 : 如果数据存在,使用create操作失败,会提示文档存在,使用index则可以成功执行</li>
</ul>
<p><code>metadata(行为操作的具体索引信息)</code> : 需要指明数据的_index,_type,_id</p>
<h3 id="批量添加"><a href="#批量添加" class="headerlink" title="批量添加"></a>批量添加</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">POST /estest/test/_bulk</span><br><span class="line">&#123;&quot;index&quot; : &#123;&quot;_id&quot; : 1&#125;&#125;</span><br><span class="line">&#123;&quot;name&quot; : &quot;xiaoming&quot;,&quot;age&quot; : &quot;11&quot;&#125;</span><br><span class="line">&#123;&quot;index&quot; : &#123;&quot;_id&quot; : 2&#125;&#125;</span><br><span class="line">&#123;&quot;name&quot; : &quot;xiaohua&quot;,&quot;age&quot; : &quot;12&quot;&#125;</span><br><span class="line">&#123;&quot;index&quot; : &#123;&quot;_id&quot; : 3&#125;&#125;</span><br><span class="line">&#123;&quot;name&quot; : &quot;xiaotian&quot;,&quot;age&quot; : &quot;13&quot;&#125;</span><br></pre></td></tr></table></figure>

<h3 id="批量删除"><a href="#批量删除" class="headerlink" title="批量删除"></a>批量删除</h3><p>删除的批量操作不需要请求体</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">POST /estest2/test2/_bulk</span><br><span class="line">&#123;&quot;delete&quot; : &#123;&quot;_id&quot; : &quot;1&quot;&#125;&#125;</span><br></pre></td></tr></table></figure>

<h3 id="批量操作"><a href="#批量操作" class="headerlink" title="批量操作"></a>批量操作</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">POST /_bulk</span><br><span class="line">&#123;&quot;delete&quot; : &#123;&quot;_index&quot; : &quot;estest&quot;, &quot;_type&quot; : &quot;test&quot;, &quot;_id&quot; : &quot;1&quot;&#125;&#125;</span><br><span class="line">&#123;&quot;create&quot; : &#123;&quot;_index&quot; : &quot;estest2&quot;, &quot;_type&quot; : &quot;test2&quot; , &quot;_id&quot; : &quot;1&quot;&#125;&#125;</span><br><span class="line">&#123;&quot;name&quot; : &quot;xiaoxiao&quot;, &quot;price&quot; : &quot;1000&quot;&#125;</span><br><span class="line">&#123;&quot;index&quot; : &#123;&quot;_index&quot; : &quot;estest2&quot;, &quot;_type&quot; : &quot;test2&quot;&#125;&#125;</span><br><span class="line">&#123;&quot;name&quot; : &quot;xiaoda&quot;, &quot;price&quot; : &quot;2000&quot;&#125;</span><br><span class="line">&#123;&quot;update&quot; : &#123;&quot;_index&quot; : &quot;estest&quot;, &quot;_type&quot; : &quot;test&quot;, &quot;_id&quot; : &quot;2&quot;&#125;&#125;</span><br><span class="line">&#123;&quot;doc&quot; : &#123;&quot;name&quot; : &quot;xiaopao&quot;&#125;&#125;</span><br></pre></td></tr></table></figure>

<p><strong>bulk一次最大处理多少数据量</strong></p>
<p>bulk会将要处理的数据载入内存中,所以数据量是有限的,最佳的数据量不是一个确定的数据,它取决于你的硬件,你的文档大小以及复杂性,你的索引以及搜索的负载</p>
<p>一般建议是1000-5000个文档,大小建议是5-15MB,默认不能超过100M,可以在es的配置文件(elasticsearch.yml)中,bulk的线程池配置是内核数+1</p>
<h2 id="聚合查询"><a href="#聚合查询" class="headerlink" title="聚合查询"></a>聚合查询</h2><p>聚合是一种基于查询条件对数据进行分桶,计算的方法</p>
<p>聚合可以嵌套,由此可以组合复杂的操作</p>
<p><strong>聚合的三种分类</strong></p>
<ul>
<li>Metric(指标聚合)<ul>
<li>对文档进行权值计算,输出结果即是权值</li>
<li>基于特定字段(field)或脚本值计算</li>
</ul>
</li>
<li>Bucketing(分桶聚合)<ul>
<li>对文档进行分组操作,把满足相关特性的文档分到一个桶里,即分桶.输出结果是包含多个文档的桶</li>
<li>基于一个关键字(field, script),以及一些桶分的判断条件进行聚合,符合条件的会分到对应的组</li>
</ul>
</li>
<li>Pipeline(管道聚合)<ul>
<li>对其它聚合操作的输出以及关联指标进行聚合</li>
<li>此类聚合的作用对象大多是桶,而不是文档,是一种后期对每一个分桶的一些计算操作</li>
</ul>
</li>
</ul>
<h3 id="指标聚合"><a href="#指标聚合" class="headerlink" title="指标聚合"></a>指标聚合</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">GET /estest3/test3/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;size&quot;: 0,</span><br><span class="line">  &quot;aggs&quot;: &#123; </span><br><span class="line">    &quot;price_min&quot;: &#123; # 结果显示的字段名</span><br><span class="line">      &quot;percentiles&quot;: &#123; # 指标聚合操作选择</span><br><span class="line">        &quot;field&quot;: &quot;price&quot; # 指定文档要进行聚合的字段</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>指标聚合操作选择</strong></p>
<ul>
<li><code>sum</code>聚合 : sum是一个求累加值的聚合</li>
<li><code>min</code>聚合 : min是一个求最小值的聚合</li>
<li><code>max</code>聚合 : max是一个求最大值的聚合</li>
<li><code>avg</code>聚合 : avg是一个求平均值的聚合</li>
<li><code>cardinality</code>聚合 : cardinality是一个求基数的聚合(相当于该字段互不相同的值有多少类,输出的是种类数)</li>
<li><code>stats</code>聚合 : stats是统计聚合,基于文档的某个值,计算出一些统计信息(min, max, sum, count, avg)</li>
<li><code>extended_stats</code>聚合 : extended_stats是扩展统计聚合,基于文档的某个值,计算出一些统计信息(比stats聚合多了sum_of_squares, variance, std_deviation, std_deviation_bounds)</li>
<li><code>geo_bounds</code>聚合 : 地理边界聚合,基于文档的某个字段(geo-point类型字段),计算出该字段所有地理坐标点的边界(左上角/右下角坐标点)</li>
<li><code>percentiles</code>聚合 : 基于聚合文档中某个数值类型的值,求百分位数聚合</li>
<li><code>value_count</code>聚合 : 值计数聚合，计算聚合文档中某个值的个数</li>
<li><code>top_hits</code>聚合 : 最高匹配权值聚合，跟踪聚合中相关性最高的文档,该聚合一般用做 sub-aggregation，以此来聚合每个桶中的最高匹配的文档</li>
</ul>
<h3 id="桶聚合"><a href="#桶聚合" class="headerlink" title="桶聚合"></a>桶聚合</h3><h4 id="histogram聚合"><a href="#histogram聚合" class="headerlink" title="histogram聚合"></a>histogram聚合</h4><p>直方图聚合,基于文档中的某个[数值类型]字段.通过计算来动态的分桶</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">分桶计算如下:</span><br><span class="line">rem = value % interval</span><br><span class="line">if (rem &lt; 0) &#123;</span><br><span class="line">    rem += interval</span><br><span class="line">&#125;</span><br><span class="line">bucket_key = value - rem</span><br><span class="line"></span><br><span class="line">//示例</span><br><span class="line">GET /elastic/doc/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;aggs&quot;: &#123;</span><br><span class="line">    &quot;elastic_agg&quot;: &#123;</span><br><span class="line">      &quot;histogram&quot;: &#123;</span><br><span class="line">        &quot;field&quot;: &quot;price&quot;,</span><br><span class="line">        &quot;interval&quot;: 50,</span><br><span class="line">        &quot;min_doc_count&quot;: 1,</span><br><span class="line">        &quot;extended_bounds&quot;: &#123;</span><br><span class="line">          &quot;min&quot;: 0,</span><br><span class="line">          &quot;max&quot;: 50</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;order&quot;: &#123;</span><br><span class="line">          &quot;_count&quot;: &quot;desc&quot;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;keyed&quot;: true,</span><br><span class="line">        &quot;missing&quot;: 0</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>参数 :</strong></p>
<ul>
<li><code>field :</code> 字段,必须为数值类型</li>
<li><code>interval :</code> 分桶间距</li>
<li><code>min_doc_count :</code> 最少文档数桶过滤,只有不少于这么多文档的桶才会返回</li>
<li><code>extended_bounds :</code> 范围扩展</li>
<li><code>order :</code> 对桶排序,如果histogram聚合有一个权限聚合类型的”直接”子聚合,那么排序可以使用子聚合中的结果</li>
<li><code>offset :</code> 桶边界位移,默认从0开始</li>
<li><code>keyed :</code> hash结构返回,默认以数组形式返回每一个桶</li>
<li><code>missing :</code> 配置缺省默认值</li>
</ul>
<h4 id="date-histogram聚合"><a href="#date-histogram聚合" class="headerlink" title="date_histogram聚合"></a>date_histogram聚合</h4><p>日期直方图聚合,基于日期类型,以[日期间隔]来桶分聚合</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">GET /elastic/doc/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;aggs&quot;: &#123;</span><br><span class="line">    &quot;elastic_agg&quot;: &#123;</span><br><span class="line">      &quot;date_histogram&quot;: &#123;</span><br><span class="line">        &quot;field&quot;: &quot;date&quot;,</span><br><span class="line">        &quot;interval&quot;: &quot;month&quot;,</span><br><span class="line">        &quot;format&quot;: &quot;yyyy-MM-dd&quot;,</span><br><span class="line">        &quot;time_zone&quot;: &quot;00:00&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>可用的时间间隔类型为 :</strong></p>
<ul>
<li>year, quarter, month, week, day, hour, minute, second</li>
<li>其中,除了year, quarter和month,其余可用小数形式</li>
</ul>
<p><strong>参数 :</strong></p>
<ul>
<li><code>field :</code> 字段,必须是日期类型</li>
<li><code>interval :</code> 分桶间距</li>
<li><code>format :</code> 定义日期的格式,配置后会返回一个key as string的字符串类型日期</li>
<li><code>time_zone :</code> 定义时区,用作时间值的调整</li>
</ul>
<h4 id="range聚合"><a href="#range聚合" class="headerlink" title="range聚合"></a>range聚合</h4><p>范围聚合,基于某个值,以[字段范围]来桶分聚合</p>
<p>范围聚合包括from值,不包括to值(区间前闭后开)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">GET /elastic/doc/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;aggs&quot;: &#123;</span><br><span class="line">    &quot;elastic_agg&quot;: &#123;</span><br><span class="line">      &quot;range&quot;: &#123;</span><br><span class="line">        &quot;field&quot;: &quot;price&quot;,</span><br><span class="line">        &quot;ranges&quot;: [ //包含三个桶</span><br><span class="line">          &#123;</span><br><span class="line">            &quot;to&quot;: 1001</span><br><span class="line">          &#125;,</span><br><span class="line">          &#123;</span><br><span class="line">            &quot;from&quot;: 1002,</span><br><span class="line">            &quot;to&quot;: 2001</span><br><span class="line">          &#125;,</span><br><span class="line">          &#123;</span><br><span class="line">            &quot;from&quot;: 2002</span><br><span class="line">          &#125;</span><br><span class="line">        ],</span><br><span class="line">        &quot;keyed&quot;: true</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">三个桶 :</span><br><span class="line">第一个桶是price值从0到1001</span><br><span class="line">第二个桶是price值从1002到2001</span><br><span class="line">第三个桶是price值从2002到最后</span><br></pre></td></tr></table></figure>

<p><strong>参数 :</strong></p>
<ul>
<li><code>ranges :</code> 配置区间数组,每一个元素是一个区间</li>
<li><code>keyed :</code> 以一个关联的唯一字符串作为键,以HASH形式返回,而不是默认的数组</li>
<li><code>script :</code> 利用script执行结果替代普通的field值进行聚合</li>
</ul>
<h4 id="date-range聚合"><a href="#date-range聚合" class="headerlink" title="date_range聚合"></a>date_range聚合</h4><p>日期范围聚合,基于日期类型的值,以[日期返回]来桶分聚合</p>
<p>日期范围可以用各种Date Math表达式</p>
<p>包括from的值,不包括to的值</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">GET /elastic/doc/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;aggs&quot;: &#123;</span><br><span class="line">    &quot;elastic_agg&quot;: &#123;</span><br><span class="line">      &quot;date_range&quot;: &#123;</span><br><span class="line">        &quot;field&quot;: &quot;date&quot;,</span><br><span class="line">        &quot;ranges&quot;: [</span><br><span class="line">          &#123;</span><br><span class="line">            &quot;from&quot;: &quot;now-10d/d&quot;,</span><br><span class="line">            &quot;to&quot;: &quot;now&quot;</span><br><span class="line">          &#125;</span><br><span class="line">        ]</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>参数 :</strong></p>
<ul>
<li><code>format :</code> 定义日期格式,配置后会返回一个[to/from]_as_string的字符串类型日期,默认是to/from的数值表示</li>
</ul>
<h4 id="IPV4-range聚合"><a href="#IPV4-range聚合" class="headerlink" title="IPV4_range聚合"></a>IPV4_range聚合</h4><p>IPV4聚合,基于一个IPV4字段,对文档进行[IPV4范围]的桶分聚合</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">GET /elastic/doc/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;aggs&quot;: &#123;</span><br><span class="line">    &quot;elastic_agg&quot;: &#123;</span><br><span class="line">      &quot;ip_range&quot;: &#123;</span><br><span class="line">        &quot;field&quot;: &quot;ip&quot;,</span><br><span class="line">        &quot;ranges&quot;: [</span><br><span class="line">          &#123;</span><br><span class="line">            &quot;from&quot;: &quot;10.0.0.5&quot;,</span><br><span class="line">            &quot;to&quot;: &quot;10.0.0.10&quot;</span><br><span class="line">          &#125;</span><br><span class="line">        ]</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="filters聚合"><a href="#filters聚合" class="headerlink" title="filters聚合"></a>filters聚合</h4><p>多过滤聚合,基于多个过滤条件,来对当前文档进行[过滤]的聚合,每个过滤都包含所有满足它的文档(多个bucket中可能重复)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">GET /elastic/doc/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;aggs&quot;: &#123;</span><br><span class="line">    &quot;elastic_agg&quot;: &#123;</span><br><span class="line">      &quot;filters&quot;: &#123;</span><br><span class="line">        &quot;filters&quot;: &#123;</span><br><span class="line">          &quot;names&quot;: &#123; &quot;term&quot;: &#123;</span><br><span class="line">            &quot;name&quot;: &quot;xiaotian&quot;</span><br><span class="line">          &#125;&#125;,</span><br><span class="line">          &quot;prices&quot; : &#123; &quot;term&quot;: &#123;</span><br><span class="line">            &quot;price&quot;: &quot;2000&quot;</span><br><span class="line">          &#125;&#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;other_bucket_key&quot;: &quot;other_messages&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>参数 :</strong></p>
<ul>
<li><code>filters :</code> 配置过滤条件,支持HASH或数组格式</li>
<li><code>other_bucket_key :</code> 作为不匹配所有过滤条件的文档的bucket名称</li>
</ul>
<h4 id="filter聚合"><a href="#filter聚合" class="headerlink" title="filter聚合"></a>filter聚合</h4><p>过滤聚合,基于一个条件,来对当前的文档进行过滤的聚合</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">GET /elastic/doc/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;aggs&quot;: &#123;</span><br><span class="line">    &quot;elastic_agg&quot;: &#123;</span><br><span class="line">      &quot;filter&quot;: &#123; &quot;term&quot;: &#123;</span><br><span class="line">        &quot;name&quot;: &quot;xiaotian&quot;</span><br><span class="line">      &#125;&#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<hr>
<p>Elasticsearch主要是观看下面的博客进行学习</p>
<p>原文链接：<a href="https://blog.csdn.net/zx711166/article/details/81811548" target="_blank" rel="noopener">https://blog.csdn.net/zx711166/article/details/81811548</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/12/05/Elasticsearch-Java-API/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/xiaoniao.jpg">
      <meta itemprop="name" content="SmallBird">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="SmallBird`s Blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2019/12/05/Elasticsearch-Java-API/" class="post-title-link" itemprop="url">Elasticsearch Java API</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2019-12-05 14:44:26" itemprop="dateCreated datePublished" datetime="2019-12-05T14:44:26+08:00">2019-12-05</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2020-03-11 17:53:00" itemprop="dateModified" datetime="2020-03-11T17:53:00+08:00">2020-03-11</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Elasticsearch/" itemprop="url" rel="index">
                    <span itemprop="name">Elasticsearch</span>
                  </a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="Elasticsearch-Java-API"><a href="#Elasticsearch-Java-API" class="headerlink" title="Elasticsearch Java API"></a>Elasticsearch Java API</h1><blockquote>
<p>TransportClient被弃用，转而支持<a href="[https://www.elastic.co/guide/en/elasticsearch/client/java-rest/7.5/java-rest-high.html](https://www.elastic.co/guide/en/elasticsearch/client/java-rest/7.5/java-rest-high.html">Java High Level REST Client</a>，并将在Elasticsearch 8.0中删除</p>
</blockquote>
<p>本节描述了Elasticsearch提供的Java API。所有的Elasticsearch操作都是使用Client对象执行的。所有操作本质上都是完全异步的(要么接受一个监听器，要么返回一个future)</p>
<p>此外，客户端上的操作可以批量累积和执行。注意，所有API都是通过Java API公开的(实际上，Java API在内部用于执行它们)</p>
<h2 id="Maven依赖"><a href="#Maven依赖" class="headerlink" title="Maven依赖"></a>Maven依赖</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;org.elasticsearch.client&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;transport&lt;/artifactId&gt;</span><br><span class="line">    &lt;version&gt;6.6.1&lt;/version&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure>

<h2 id="createClient"><a href="#createClient" class="headerlink" title="createClient"></a>createClient</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">public final static String HOST = &quot;192.168.101.32&quot;;</span><br><span class="line"></span><br><span class="line">// http请求的端口是9200，客户端是9300</span><br><span class="line">public final static int PORT = 9300;</span><br><span class="line"></span><br><span class="line">public TransportClient getConnection() throws Exception &#123;</span><br><span class="line">    //设置集群名称</span><br><span class="line">    Settings settings = Settings.builder().put(&quot;cluster.name&quot;, &quot;elasticsearch&quot;).build();</span><br><span class="line">    //创建Client</span><br><span class="line">    TransportClient client = new PreBuiltTransportClient(settings)</span><br><span class="line">            .addTransportAddresses(new TransportAddress(InetAddress.getByName(HOST), PORT));</span><br><span class="line">    return client;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="createIndex"><a href="#createIndex" class="headerlink" title="createIndex"></a>createIndex</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">public void createIndex(TransportClient client) throws Exception &#123;</span><br><span class="line">    JSONObject jsonObject = new JSONObject();</span><br><span class="line">    jsonObject.put(&quot;orderNo&quot;, new SimpleDateFormat(&quot;yyyyMMddHHmmss&quot;).format(new Date()) + &quot;001&quot;);</span><br><span class="line">    jsonObject.put(&quot;orderName&quot;, &quot;购买元宝&quot;);</span><br><span class="line">    jsonObject.put(&quot;orderTime&quot;, new Date());</span><br><span class="line">    jsonObject.put(&quot;price&quot;, 1.5);</span><br><span class="line">    jsonObject.put(&quot;ip&quot;, &quot;192.168.1.111&quot;);</span><br><span class="line"></span><br><span class="line">    IndexResponse indexResponse = client.prepareIndex(&quot;expay&quot;, &quot;order&quot;).setSource(jsonObject.toString(), XContentType.JSON).get();</span><br><span class="line">    System.out.println(&quot;索引名称：&quot; + indexResponse.getIndex());</span><br><span class="line">    System.out.println(&quot;类型：&quot; + indexResponse.getType());</span><br><span class="line">    System.out.println(&quot;文档ID：&quot; + indexResponse.getId());</span><br><span class="line">    System.out.println(&quot;当前实例状态：&quot; + indexResponse.status());</span><br><span class="line"></span><br><span class="line">    client.close();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="query"><a href="#query" class="headerlink" title="query"></a>query</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">public void query(TransportClient client) throws Exception &#123;</span><br><span class="line">    GetResponse documentFields = client.prepareGet(&quot;expay&quot;, &quot;order&quot;, &quot;-c9ez24B_mbpSSlrdZat&quot;).execute().actionGet();</span><br><span class="line">    System.out.println(documentFields.getSourceAsString());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="update"><a href="#update" class="headerlink" title="update"></a>update</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">public void update (TransportClient client) throws Exception &#123;</span><br><span class="line">    JSONObject json = new JSONObject();</span><br><span class="line">    json.put(&quot;user&quot;, &quot;Joe&quot;);</span><br><span class="line">    json.put(&quot;age&quot;, &quot;22&quot;);</span><br><span class="line">    json.put(&quot;sex&quot;, &quot;男&quot;);</span><br><span class="line">    json.put(&quot;orderTime&quot;, &quot;6666666&quot;);</span><br><span class="line">    UpdateResponse response = client.prepareUpdate(&quot;expay&quot;, &quot;order&quot;, &quot;-c9ez24B_mbpSSlrdZat&quot;).setDoc(json.toJSONString(), XContentType.JSON).get();</span><br><span class="line">    System.out.println(&quot;索引名称：&quot; + response.getIndex());</span><br><span class="line">    System.out.println(&quot;类型：&quot; + response.getType());</span><br><span class="line">    System.out.println(&quot;文档ID：&quot; + response.getId());</span><br><span class="line">    System.out.println(&quot;当前实例状态：&quot; + response.status());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="delete"><a href="#delete" class="headerlink" title="delete"></a>delete</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">public void delete (TransportClient client) throws Exception &#123;</span><br><span class="line">    DeleteResponse response = client.prepareDelete(&quot;expay&quot;, &quot;order&quot;, &quot;-c9ez24B_mbpSSlrdZat&quot;).get();</span><br><span class="line">    System.out.println(&quot;索引名称：&quot; + response.getIndex());</span><br><span class="line">    System.out.println(&quot;类型：&quot; + response.getType());</span><br><span class="line">    System.out.println(&quot;文档ID：&quot; + response.getId());</span><br><span class="line">    System.out.println(&quot;当前实例状态：&quot; + response.status());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="searchAll"><a href="#searchAll" class="headerlink" title="searchAll"></a>searchAll</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">public void searchAll (TransportClient client) throws Exception &#123;</span><br><span class="line">    SearchRequestBuilder searchRequestBuilder = client.prepareSearch(&quot;expay&quot;).setTypes(&quot;order&quot;);</span><br><span class="line">    SearchResponse searchResponse = searchRequestBuilder.setQuery(QueryBuilders.matchAllQuery()).execute().actionGet();</span><br><span class="line">    SearchHits hits = searchResponse.getHits();</span><br><span class="line">    for (SearchHit hit:</span><br><span class="line">            hits) &#123;</span><br><span class="line">        System.out.println(hit.getSourceAsString());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/12/04/Elasticsearch%E5%9F%BA%E7%A1%80%E4%B8%8E%E5%AE%89%E8%A3%85/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/xiaoniao.jpg">
      <meta itemprop="name" content="SmallBird">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="SmallBird`s Blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2019/12/04/Elasticsearch%E5%9F%BA%E7%A1%80%E4%B8%8E%E5%AE%89%E8%A3%85/" class="post-title-link" itemprop="url">Elasticsearch基础与安装</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2019-12-04 16:12:16" itemprop="dateCreated datePublished" datetime="2019-12-04T16:12:16+08:00">2019-12-04</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2020-03-11 17:53:00" itemprop="dateModified" datetime="2020-03-11T17:53:00+08:00">2020-03-11</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Elasticsearch/" itemprop="url" rel="index">
                    <span itemprop="name">Elasticsearch</span>
                  </a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="Elasticsearch介绍"><a href="#Elasticsearch介绍" class="headerlink" title="Elasticsearch介绍"></a>Elasticsearch介绍</h1><h2 id="Elasticsearch概述"><a href="#Elasticsearch概述" class="headerlink" title="Elasticsearch概述"></a>Elasticsearch概述</h2><p>Elasticsearch是一个基于Lucene的搜索服务器.它提供了一个分布式多用户能力的全文搜索引擎,基于RESTfulweb接口.Elasticsearch是用Java开发的,并作为Apache许可条款下的开放源码发布,是当前流行的企业级搜索引擎.设计用于云计算中,能够达到实时搜索,稳定,可靠,快速,安装使用方便.构建在全文检索开源软件Lucene之上的Elasticsearch,不仅能对海量规模的数据完成分布式索引与检索,还能提供数据聚合分析.据国际权威的数据库产品评测机构DB Engines的统计,在2016年1月,Elasticsearch已超过Solr等,成为排名第一的搜索引擎类应用<br>概括来说: 基于RESTful标准的高扩展高可用的实时数据分析的全文搜索工具</p>
<h2 id="Elasticsearch基本概念"><a href="#Elasticsearch基本概念" class="headerlink" title="Elasticsearch基本概念"></a>Elasticsearch基本概念</h2><h3 id="NRT"><a href="#NRT" class="headerlink" title="NRT"></a>NRT</h3><p>NRT(接近实时),Elasticsearch是一个接近实时的搜索平台.这意味着,从索引一个文档直到这个文档能够被搜索到有一个轻微的延迟(通常是1秒)</p>
<h3 id="Cluster"><a href="#Cluster" class="headerlink" title="Cluster"></a>Cluster</h3><p><strong>ElasticSearch集群实际上是一个分布式系统，它需要具备两个特性:</strong></p>
<p>1.高可用性</p>
<ul>
<li>服务可用性：允许有节点停止服务；</li>
<li>数据可用性：部分节点丢失，不会丢失数据</li>
</ul>
<p>2.可扩展性</p>
<ul>
<li>随着请求量的不断提升，数据量的不断增长，系统可以将数据分布到其他节点，实现水平扩展</li>
</ul>
<p><strong>集群健康值</strong></p>
<ul>
<li>green：所有主要分片和复制分片都可用</li>
<li>yellow：所有主要分片可用，但不是所有复制分片都可用</li>
<li>red：不是所有的主要分片都可用</li>
</ul>
<h3 id="Node"><a href="#Node" class="headerlink" title="Node"></a>Node</h3><p><strong>节点是什么:</strong></p>
<ul>
<li>节点是一个ElasticSearch的实例，其本质就是一个Java进程；</li>
<li>一台机器上可以运行多个ElasticSearch实例，但是建议在生产环境中一台机器上只运行一个ElasticSearch实例；</li>
</ul>
<p>Node 是组成集群的一个单独的服务器，用于存储数据并提供集群的搜索和索引功能。与集群一样，节点也有一个唯一名字，默认在节点启动时会生成一个uuid作为节点名</p>
<p>该名字也可以手动指定。单个集群可以由任意数量的节点组成。如果只启动了一个节点，则会形成一个单节点的集群</p>
<h3 id="Shard"><a href="#Shard" class="headerlink" title="Shard"></a>Shard</h3><p><code>Primary Shard(主分片)</code></p>
<p>ES中的shard用来解决节点的容量上限问题,，通过主分片，可以将数据分布到集群内的所有节点之上</p>
<p>主分片数是在索引创建时指定，后续不允许修改，除非Reindex</p>
<p>一个索引中的数据保存在多个分片中(默认为一个)，相当于水平分表。一个分片便是一个Lucene 的实例，它本身就是一个完整的搜索引擎。我们的文档被存储和索引到分片内，但是应用程序是直接与索引而不是与分片进行交互</p>
<p><strong>分片的设定</strong></p>
<p>对于生产环境中分片的设定，需要提前做好容量规划，因为主分片数是在索引创建时预先设定的，后续无法修改。</p>
<p><em>分片数设置过小</em></p>
<ul>
<li>导致后续无法增加节点进行水平扩展。</li>
<li>导致分片的数据量太大，数据在重新分配时耗时；</li>
</ul>
<p><em>分片数设置过大</em></p>
<ul>
<li>影响搜索结果的相关性打分，影响统计结果的准确性；</li>
<li>单个节点上过多的分片，会导致资源浪费，同时也会影响性能；</li>
</ul>
<h3 id="Replica"><a href="#Replica" class="headerlink" title="Replica"></a>Replica</h3><p><strong>副本有两个重要作用:</strong></p>
<ol>
<li>服务高可用：由于数据只有一份,如果一个node挂了,那存在上面的数据就都丢了,有了replicas,只要不是存储这条数据的node全挂了,数据就不会丢。因此分片副本不会与主分片分配到同一个节点</li>
<li>扩展性能：通过在所有replicas上并行搜索提高搜索性能.由于replicas上的数据是近实时的(near realtime),因此所有replicas都能提供搜索功能,通过设置合理的replicas数量可以极高的提高搜索吞吐量</li>
</ol>
<h3 id="Index"><a href="#Index" class="headerlink" title="Index"></a>Index</h3><p>索引是具有某种相似特征文档的集合.例如,你可以有一个顾客数据索引,产品目录索引和订单数据索引.索引有一个名称(必须是小写得)标识,该名称用于对其中的文档执行索引,搜索,更新和删除操作时引用索引 {相当于关系数据库中的数据库}</p>
<h3 id="Type"><a href="#Type" class="headerlink" title="Type"></a>Type</h3><p>索引和文档之间有个类型的概念 {相当于关系数据库中的Table}</p>
<blockquote>
<p>V6.0之前,单Index多Type</p>
</blockquote>
<blockquote>
<p>V6.0-V7.0, 单Index单Type</p>
</blockquote>
<blockquote>
<p>V7.0, 不建议使用Type</p>
</blockquote>
<blockquote>
<p>V8.0, 完全不支持使用Type</p>
</blockquote>
<h3 id="Document"><a href="#Document" class="headerlink" title="Document"></a>Document</h3><p>Index里面单条的记录称为Document {相当于关系数据库中的行}</p>
<h3 id="概念之间关系"><a href="#概念之间关系" class="headerlink" title="概念之间关系"></a>概念之间关系</h3><ul>
<li>一个节点对应一个ES实例；</li>
<li>一个节点可以有多个index（索引）;</li>
<li>一个index可以有多个shard（分片）；</li>
<li>一个分片是一个lucene index（此处的index是lucene自己的概念，与ES的index不是一回事）</li>
</ul>
<h3 id="文档源数据"><a href="#文档源数据" class="headerlink" title="文档源数据"></a>文档源数据</h3><p><code>_index</code> 文档所属索引名称</p>
<p><code>_type</code> 文档所属类型名</p>
<p><code>_id</code> Doc的主键。在写入的时候，可以指定该Doc的ID值，如果不指定，则系统自动生成一个唯一的UUID值</p>
<p><code>_version</code> 文档的版本信息。Elasticsearch通过使用version来保证对文档的变更能以正确的顺序执行，避免乱序造成的数据丢失</p>
<p><code>_seq_no</code> 严格递增的顺序号，每个文档一个，Shard级别严格递增，保证后写入的Doc的_seq_no大于先写入的Doc的_seq_no</p>
<p><code>primary_term</code> primary_term也和<code>_seq_no</code> 一样是一个整数，每当Primary Shard发生重新分配时，比如重启，Primary选举等，_primary_term会递增1</p>
<p><code>found</code> 查询的ID正确那么ture, 如果 Id 不正确，就查不到数据，found字段就是false</p>
<p><code>_source</code> 文档的原始JSON数据</p>
<h1 id="Elasticsearch安装"><a href="#Elasticsearch安装" class="headerlink" title="Elasticsearch安装"></a>Elasticsearch安装</h1><h2 id="下载安装包并解压"><a href="#下载安装包并解压" class="headerlink" title="下载安装包并解压"></a>下载安装包并解压</h2><ol>
<li><a href="https://www.elastic.co/cn/downloads/elasticsearch" target="_blank" rel="noopener">官网下载安装包</a></li>
<li>命令下载: {curl -L -O <a href="https://artifacts.elastic.co/downloads/elasticsearch/elasticsearch-7.2.0-linux-x86_64.tar.gz}" target="_blank" rel="noopener">https://artifacts.elastic.co/downloads/elasticsearch/elasticsearch-7.2.0-linux-x86_64.tar.gz}</a></li>
<li>解压安装包: tar -zxvf elasticsearch-7.2.0-linux-x86_64.tar.gz</li>
</ol>
<h2 id="修改配置文件"><a href="#修改配置文件" class="headerlink" title="修改配置文件"></a>修改配置文件</h2><p><strong>elasticsearch.yml</strong></p>
<ul>
<li>cluster.name: 集群名字</li>
<li>node.name: 节点名称</li>
<li>network.host: 节点IP</li>
<li>http.port: 端口号</li>
<li>discovery.zen.ping.unicast.hosts: 集群节点</li>
</ul>
<h2 id="创建用户并启动"><a href="#创建用户并启动" class="headerlink" title="创建用户并启动"></a>创建用户并启动</h2><p><strong>创建用户:</strong> adduser es -p es<br><strong>更改elasticsearch安装包所属用户:</strong> chown -R es ./elasticsearch</p>
<p><strong>切换用户:</strong> su es</p>
<p><strong>启动:</strong> ${ES_HOME}/bin/elasticsearch<br><strong>验证:</strong> curl localhost:9200</p>
<h2 id="启动错误处理"><a href="#启动错误处理" class="headerlink" title="启动错误处理"></a>启动错误处理</h2><h3 id="java-lang-RuntimeException-can-not-run-elasticsearch-as-root"><a href="#java-lang-RuntimeException-can-not-run-elasticsearch-as-root" class="headerlink" title="java.lang.RuntimeException: can not run elasticsearch as root"></a>java.lang.RuntimeException: can not run elasticsearch as root</h3><p>出于系统安全考虑设置的条件。由于ElasticSearch可以接收用户输入的脚本并且执行，为了系统安全考虑，建议创建一个单独的用户用来运行ElasticSearch</p>
<h3 id="ERROR-3-bootstrap-checks-failed"><a href="#ERROR-3-bootstrap-checks-failed" class="headerlink" title="ERROR: [3] bootstrap checks failed"></a>ERROR: [3] bootstrap checks failed</h3><p><strong>[1]: max file descriptors [4096] for elasticsearch process is too low, increase to at least [65535]</strong></p>
<p>文件描述符太低解决办法 :<br>切换root用户编辑文件/etc/security/limits.conf添加:<br>esuser soft nofile 65536 # soft表示为超过这个值就会有warnning<br>esuser hard nofile 65536 # hard则表示不能超过这个值 </p>
<p>代表线程数 ,如果有错误[max number of threads [1024] for user [hadoop] is too low, increase to at least [2048]]需要添加此配置<br>esuser soft nproc 4096<br>esuser hard nproc 4096</p>
<p>修改之后重新登陆新用户才能生效</p>
<p><strong>[2]: max virtual memory areas vm.max_map_count [65530] is too low, increase to at least [262144]</strong></p>
<p>进程的虚拟内存空间不足解决办法 :<br>切换root用户编辑文件/etc/sysctl.conf添加:<br>vm.max_map_count=655360<br>执行一下命令生效 : sysctl -p</p>
<p><strong>[3]: the default discovery settings are unsuitable for production use; at least one of [discovery.seed_hosts, discovery.seed_providers, cluster.initial_master_nodes] must be configured</strong></p>
<p>默认发现设置不适合生产使用; 必须至少配置[discovery.seed_hosts, discovery.seed_providers, cluster.initial_master_nodes]的一个<br>解决办法 :<br>打开配置文件elasticsearch.yml修改:<br>cluster.initial_master_nodes: [“node-1”, “node-2”] 修改为 cluster.initial_master_nodes: [“node-1”]</p>
<h1 id="Kibana安装"><a href="#Kibana安装" class="headerlink" title="Kibana安装"></a>Kibana安装</h1><h2 id="下载安装包并解压-1"><a href="#下载安装包并解压-1" class="headerlink" title="下载安装包并解压"></a>下载安装包并解压</h2><p><a href="https://www.elastic.co/cn/downloads/kibana" target="_blank" rel="noopener">Kibana Download</a></p>
<blockquote>
<p>注意与Elasticsearch版本相同,并更改解压后Kibana安装包所属用户为elasticsearch用户</p>
</blockquote>
<h2 id="更改配置并启动"><a href="#更改配置并启动" class="headerlink" title="更改配置并启动"></a>更改配置并启动</h2><p>修改配置文件: <code>vim ${KIBANA_HOME}/config/kibana.yml</code></p>
<ul>
<li>server.host: “localhost” (指定Kibana所在服务器地址)</li>
<li>elasticsearch.hosts: [“<a href="http://localhost:9200&quot;]" target="_blank" rel="noopener">http://localhost:9200&quot;]</a> (指定elasticsearch地址)</li>
</ul>
<p>启动: <code>${KIBANA_HOME}/bin/kibana</code></p>
<p>验证: <code>http://localhost:5601</code></p>
<h2 id="汉化"><a href="#汉化" class="headerlink" title="汉化"></a>汉化</h2><h3 id="6-X版本"><a href="#6-X版本" class="headerlink" title="6.X版本"></a>6.X版本</h3><p><a href="https://github.com/anbai-inc/Kibana_Hanization/" target="_blank" rel="noopener">下载汉化包</a></p>
<ol>
<li>拷贝此项目中的<code>translations</code>文件夹到Kibana目录下的<code>src/legacy/core_plugins/kibana/</code>目录</li>
<li>修改配置文件<code>kibana.yml</code>中的配置项: <code>i18n.locale: &quot;zh-CN&quot;</code></li>
<li>重启Kibana,汉化完成</li>
</ol>
<h3 id="7-X版本"><a href="#7-X版本" class="headerlink" title="7.X版本"></a>7.X版本</h3><ol>
<li>官方自带汉化资源文件</li>
<li>修改配置文件<code>kibana.yml</code>中的配置项: <code>i18n.locale: &quot;zh-CN&quot;</code></li>
<li>重启Kibana,汉化完成</li>
</ol>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/11/15/Netty%E6%8C%87%E5%8D%97/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/xiaoniao.jpg">
      <meta itemprop="name" content="SmallBird">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="SmallBird`s Blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2019/11/15/Netty%E6%8C%87%E5%8D%97/" class="post-title-link" itemprop="url">Netty指南</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2019-11-15 16:20:07" itemprop="dateCreated datePublished" datetime="2019-11-15T16:20:07+08:00">2019-11-15</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2020-03-11 17:53:00" itemprop="dateModified" datetime="2020-03-11T17:53:00+08:00">2020-03-11</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Netty/" itemprop="url" rel="index">
                    <span itemprop="name">Netty</span>
                  </a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="Netty-指南"><a href="#Netty-指南" class="headerlink" title="Netty 指南"></a>Netty 指南</h1><h2 id="为什么选择Netty"><a href="#为什么选择Netty" class="headerlink" title="为什么选择Netty?"></a>为什么选择Netty?</h2><p>Netty是业界最流行的NIO框架之一,它的健壮性,功能,性能,可定制性和可扩展性在同类框架中都是首屈一指的,它已经得到成百上千的商用项目验证,例如Hadoop的RPC框架Avro就使用了Netty作为底层通信框架,其他还有业界主流的RPC框架,也使用Netty来构建高性能的异步通信能力</p>
<p><strong>通过对Netty的分析,它的优点如下:</strong></p>
<ul>
<li>API使用简单,开发门槛低</li>
<li>功能强大,预置了多种编解码功能,支持多种主流协议</li>
<li>定制能力强,可以通过ChannelHandler对通信框架进行灵活地扩展</li>
<li>性能高,通过与其他业界主流的NIO框架对比,Netty的综合性能最优</li>
<li>成熟,稳定,Netty修复了已经发现的所有JDK NIO BUG,业务开发人员不需要在为NIO的BUG而烦恼</li>
<li>社区活跃,版本迭代周期短,发现的BUG可以被及时修复,同时,更多的新功能会加入</li>
<li>经历了大规模的商用应用考研,质量得到验证</li>
</ul>
<p>Netty逐渐成为了Java NIO编程的首选框架</p>
<h2 id="Netty简介"><a href="#Netty简介" class="headerlink" title="Netty简介"></a>Netty简介</h2><p>Netty是一个异步事件驱动驱动的网络应用程序框架,用于快速开发可维护的高性能协议服务器和客户端</p>
<p>Netty是一个NIO客户端服务器框架,可以快速轻松地开发网络应用程序,例如协议服务器和客户端.它极大地简化了TCP和UDP套接字服务器等网络编程</p>
<p>“快速简便”并不意味着最终的应用程序将遭受可维护性或性能问题的困扰.Netty经过精心设计,结合了许多协议(例如FTP,SMTP,HTTP以及各种基于二进制和文本的旧式协议)的实施经验.结果,Netty成功地找到了一种无需妥协即可轻松实现开发,性能,稳定性和灵活性的方法</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

  </div>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="page-number" href="/page/3/">3</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right" aria-label="下一页"></i></a>
  </nav>



          </div>
          

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <img class="site-author-image" itemprop="image" alt="SmallBird"
    src="/images/xiaoniao.jpg">
  <p class="site-author-name" itemprop="name">SmallBird</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives">
          <span class="site-state-item-count">23</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
        <span class="site-state-item-count">10</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
        <span class="site-state-item-count">14</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/SmallBird6" title="GitHub &amp;rarr; https:&#x2F;&#x2F;github.com&#x2F;SmallBird6" rel="noopener" target="_blank"><i class="fa fa-fw fa-github"></i>GitHub</a>
      </span>
  </div>


  <div class="links-of-blogroll motion-element">
    <div class="links-of-blogroll-title">
      <i class="fa fa-fw fa-globe"></i>
      友情链接
    </div>
    <ul class="links-of-blogroll-list">
        <li class="links-of-blogroll-item">
          <a href="http://smallbird6.gitee.io/smallbirdblog" title="http:&#x2F;&#x2F;smallbird6.gitee.io&#x2F;smallbirdblog" rel="noopener" target="_blank">SmallBird</a>
        </li>
    </ul>
  </div>

      </div>
        <div class="back-to-top motion-element">
          <i class="fa fa-arrow-up"></i>
          <span>0%</span>
        </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">SmallBird</span>
</div>
  <div class="theme-info">主题 – <a href="https://theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a>
  </div>

        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>












        
      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>
<script src="/js/utils.js"></script><script src="/js/motion.js"></script>
<script src="/js/schemes/pisces.js"></script>
<script src="/js/next-boot.js"></script><script src="/js/bookmark.js"></script>



  
















  

  

</body>
</html>
